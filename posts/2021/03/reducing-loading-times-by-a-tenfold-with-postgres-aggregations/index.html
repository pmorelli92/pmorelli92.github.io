<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Pablo Morelli">
<meta name="description" content="Devandchill is a coding blog where I share my ideas and insights on various programming topics." />
<meta name="keywords"
    content="blog, development, programming, tech, postgres, array, aggregations, query, json, performance, optimization" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://devandchill.com/posts/2021/03/reducing-loading-times-by-a-tenfold-with-postgres-aggregations/" />


<title>
    
    Reducing loading times by a tenfold with Postgres aggregations :: Dev &amp; Chill  — A blog about coding
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" type="text/css" href="/main.045f18da88f8cb42336977558c8919c77ba0afb78827b7a1250d971d6cfd080e.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Reducing loading times by a tenfold with Postgres aggregations">
<meta itemprop="description" content="Time to market is a very important part of the life of the developers. In the agile world, a team must make a balance between speed and code quality. This does not necessarily mean that the code will not be good nor tested, but sometimes it limits exploration. A limited exploration means that a developer will do things the way he/she is used to.
At least from my experience, SQL is taught in university/courses in an outdated way, where a lot of new features are never explored and people are not aware of this."><meta itemprop="datePublished" content="2021-03-21T12:31:00+01:00" />
<meta itemprop="dateModified" content="2021-03-21T12:31:00+01:00" />
<meta itemprop="wordCount" content="1582"><meta itemprop="image" content="https://devandchill.com/og-image.png"/>
<meta itemprop="keywords" content="postgres,array,aggregations,query,json,performance,optimization," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://devandchill.com/og-image.png"/>

<meta name="twitter:title" content="Reducing loading times by a tenfold with Postgres aggregations"/>
<meta name="twitter:description" content="Time to market is a very important part of the life of the developers. In the agile world, a team must make a balance between speed and code quality. This does not necessarily mean that the code will not be good nor tested, but sometimes it limits exploration. A limited exploration means that a developer will do things the way he/she is used to.
At least from my experience, SQL is taught in university/courses in an outdated way, where a lot of new features are never explored and people are not aware of this."/>







<meta property="article:published_time" content="2021-03-21 12:31:00 &#43;0100 CET" />







<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138171880-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138171880-1');
</script>



    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <img src="/dev-n-chill-logo.svg" alt="Dev &amp; Chill" />
        
    </div>
</a>


        <span class="header__right">
            
            <nav class="menu">
    <ul class="menu__inner"><li><a href="/blog">The blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/posts">Posts</a></li>
    </ul>
</nav>

            <span class="menu-trigger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">

  <div class="post-info">
    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-clock">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      8 minutes

      
    </p>
  </div>

  <article>
    <h1 class="post-title">
      <a href="https://devandchill.com/posts/2021/03/reducing-loading-times-by-a-tenfold-with-postgres-aggregations/">Reducing loading times by a tenfold with Postgres aggregations</a>
    </h1>

    

    

    

    <div class="post-content">
      <p>Time to market is a very important part of the life of the developers. In the agile world, a team must make a balance between speed and code quality. This does not necessarily mean that the code will not be good nor tested, but sometimes it limits exploration. A limited exploration means that a developer will do things the way he/she is used to.</p>
<p>At least from my experience, SQL is taught in university/courses in an outdated way, where a lot of new features are never explored and people are not aware of this. In 2013, Postgres released version 9.3 which introduced json aggregations, however not a lot of people are aware of this functionality.</p>
<p>In this post, you will see how this can be used to fetch data in 1..N relationships with a single trip to the database.</p>
<h3 id="enter-the-model">Enter the model</h3>
<p>Let&rsquo;s imagine the following model:</p>
<figure><img src="/posts/images/agg_data_model.svg"
         alt="table data model"/>
</figure>

<p>Populated with the following data:</p>
<p><strong>Table person</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">fbab22a3-f7bc-422c-942f-d184ad189e29</td>
<td style="text-align:left">Pablo</td>
</tr>
</tbody>
</table>
<p><strong>Table animal</strong></p>
<table>
<thead>
<tr>
<th>id</th>
<th>owner_id</th>
<th>type</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>5f2461a9-6c62-453e-9182-38cd0fa76e01</td>
<td>fbab22a3-f7bc-422c-942f-d184ad189e29</td>
<td>cat</td>
<td>Bills</td>
</tr>
</tbody>
</table>
<p><strong>Table vaccine</strong></p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>0ee28253-5b94-4096-926c-d33ceb22d24d</td>
<td>Feline herpesvirus</td>
</tr>
<tr>
<td>6cf5487a-ba06-42e7-9e80-226590752a77</td>
<td>Rabies</td>
</tr>
</tbody>
</table>
<p><strong>Table animal_vaccine</strong></p>
<table>
<thead>
<tr>
<th>vaccine_id</th>
<th>animal_id</th>
<th>applied_on</th>
</tr>
</thead>
<tbody>
<tr>
<td>0ee28253-5b94-4096-926c-d33ceb22d24d</td>
<td>5f2461a9-6c62-453e-9182-38cd0fa76e01</td>
<td>2021-02-10</td>
</tr>
<tr>
<td>6cf5487a-ba06-42e7-9e80-226590752a77</td>
<td>5f2461a9-6c62-453e-9182-38cd0fa76e01</td>
<td>2022-02-10</td>
</tr>
</tbody>
</table>
<p><a href="https://gist.github.com/pmorelli92/8d93820185bf9eb5142d43f604affd20"  target="_blank" rel="noreferrer noopener" ><strong>Here you can find the <code>sql</code> script for creating the database and tables with the data listed above.</strong></a>
</p>
<p>Now, imagine that another service needs to obtain all the people named <code>Pablo</code> with all their pets and the vaccines applied to them. Below you can find different approaches to fetch the required data for creating the required response.</p>
<h3 id="approach-1-many-database-trips">Approach 1: Many database trips</h3>
<ul>
<li>A query will be executed to fetch all the vaccines from such table.</li>
<li>A query will be executed to fetch all the people named <code>Pablo</code>.</li>
<li>For each person filtered, a query will be executed to fetch all the animals that the person owns.</li>
<li>For each animal filtered, a query will be executed to fetch all the vaccines applied on it.</li>
</ul>
<p>This approach is pretty much the one you don&rsquo;t want to have. In code, it is simple to follow, and with some connection pooling you don&rsquo;t have the overhead of creating database connection for each query; however the database trip is still there, and network latency applies. This is also not scalable when you are fetching for example 15 people, as you can see below.</p>
<p>A query to fetch vaccines:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id<span style="color:#eceff4">,</span> name <span style="color:#81a1c1;font-weight:bold">FROM</span> vaccine
</span></span></code></pre></div><p>A query to fetch people:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id<span style="color:#eceff4">,</span> name <span style="color:#81a1c1;font-weight:bold">FROM</span> person <span style="color:#81a1c1;font-weight:bold">WHERE</span> name <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;Pablo&#39;</span>
</span></span></code></pre></div><p>15 queries to fetch all the animals a person owns:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id<span style="color:#eceff4">,</span> <span style="color:#81a1c1;font-weight:bold">type</span><span style="color:#eceff4">,</span> name <span style="color:#81a1c1;font-weight:bold">FROM</span> animal <span style="color:#81a1c1;font-weight:bold">WHERE</span> owner_id <span style="color:#81a1c1">=</span> <span style="color:#bf616a">$</span><span style="color:#b48ead">1</span>
</span></span></code></pre></div><p>30 trips to fetch vaccines considering that each person may have 2 animals:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> vaccine_id<span style="color:#eceff4">,</span> applied_on <span style="color:#81a1c1;font-weight:bold">FROM</span> animal_vaccine <span style="color:#81a1c1;font-weight:bold">WHERE</span> animal_id <span style="color:#81a1c1">=</span> <span style="color:#bf616a">$</span><span style="color:#b48ead">1</span>
</span></span></code></pre></div><p>A total of 47 trips to the database fetching this information. We can do better than this.</p>
<h3 id="approach-15-less-database-trips">Approach 1.5: Less database trips</h3>
<p>A query will be executed to fetch all the vaccines from such table:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id<span style="color:#eceff4">,</span> name <span style="color:#81a1c1;font-weight:bold">FROM</span> vaccine
</span></span></code></pre></div><p>A query will be executed to fetch all the people named <code>Pablo</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id<span style="color:#eceff4">,</span> name <span style="color:#81a1c1;font-weight:bold">FROM</span> person <span style="color:#81a1c1;font-weight:bold">WHERE</span> name <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;Pablo&#39;</span>
</span></span></code></pre></div><p>A query will be executed to fetch all animals whose owner_id is contained on the previous returned list:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> owner_id<span style="color:#eceff4">,</span> id<span style="color:#eceff4">,</span> <span style="color:#81a1c1;font-weight:bold">type</span><span style="color:#eceff4">,</span> name <span style="color:#81a1c1;font-weight:bold">FROM</span> animal <span style="color:#81a1c1;font-weight:bold">WHERE</span> owner_id <span style="color:#81a1c1;font-weight:bold">IN</span> <span style="color:#eceff4">(</span><span style="color:#bf616a">$</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>A query will be executed to fetch all the vaccines for all the animals returned:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> animal_id<span style="color:#eceff4">,</span> vaccine_id<span style="color:#eceff4">,</span> applied_on <span style="color:#81a1c1;font-weight:bold">FROM</span> animal_vaccine <span style="color:#81a1c1;font-weight:bold">WHERE</span> animal_id <span style="color:#81a1c1;font-weight:bold">IN</span> <span style="color:#eceff4">(</span><span style="color:#bf616a">$</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>This approach is a middle ground, and the main benefit is that the quantity of queries are not related to the amount of data: returning 15 people, will still execute 4 queries.</p>
<p>On the other hand, the code complexity increases as you need a more complex mapping. Note that on the last two queries the <code>owner_id</code> and <code>animal_id</code> need to be retrieved, as the list of animals will be iterated to add each animal to the corresponding owner; and the same happens with the vaccines.</p>
<h3 id="approach-2-how-orm-does-it">Approach 2: How ORM does it</h3>
<p>This is a single query approach, but with one particularity, repeatable data:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#eceff4">.</span>id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    a<span style="color:#eceff4">.</span>id <span style="color:#81a1c1;font-weight:bold">AS</span> animal_id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    a<span style="color:#eceff4">.</span><span style="color:#81a1c1;font-weight:bold">type</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    a<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    v<span style="color:#eceff4">.</span>id <span style="color:#81a1c1;font-weight:bold">AS</span> vaccine_id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    v<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    av<span style="color:#eceff4">.</span>applied_on
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> person p
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">LEFT</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> animal a <span style="color:#81a1c1;font-weight:bold">ON</span> p<span style="color:#eceff4">.</span>id <span style="color:#81a1c1">=</span> a<span style="color:#eceff4">.</span>owner_id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">LEFT</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> animal_vaccine av <span style="color:#81a1c1;font-weight:bold">ON</span> av<span style="color:#eceff4">.</span>animal_id <span style="color:#81a1c1">=</span> a<span style="color:#eceff4">.</span>id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">LEFT</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> vaccine v <span style="color:#81a1c1;font-weight:bold">ON</span> av<span style="color:#eceff4">.</span>vaccine_id <span style="color:#81a1c1">=</span> v<span style="color:#eceff4">.</span>id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> p<span style="color:#eceff4">.</span>name <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;Pablo&#39;</span>
</span></span></code></pre></div><p>Executing the query above will print the following result:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>animal_id</th>
<th>type</th>
<th>name</th>
<th>vaccine_id</th>
<th>name</th>
<th>applied_on</th>
</tr>
</thead>
<tbody>
<tr>
<td>fbab22a3-f7bc-422c-942f-d184ad189e29</td>
<td>Pablo</td>
<td>5f2461a9-6c62-453e-9182-38cd0fa76e01</td>
<td>cat</td>
<td>Bills</td>
<td>0ee28253-5b94-4096-926c-d33ceb22d24d</td>
<td>Feline herpesvirus</td>
<td>2021-02-10</td>
</tr>
<tr>
<td>fbab22a3-f7bc-422c-942f-d184ad189e29</td>
<td>Pablo</td>
<td>5f2461a9-6c62-453e-9182-38cd0fa76e01</td>
<td>cat</td>
<td>Bills</td>
<td>6cf5487a-ba06-42e7-9e80-226590752a77</td>
<td>Rabies</td>
<td>2022-02-10</td>
</tr>
</tbody>
</table>
<p>While generally ORM does the magic mapping behind the scenes and the developer just gets the data aggregated correctly; if a developer wants to map this data manually he/she will need to consider:</p>
<ul>
<li>A person can appear more than once.</li>
<li>An animal can appear more than once.</li>
</ul>
<p>Also, keep attention to the <code>LEFT JOIN</code> here. A person may not have an animal, or an animal may not have any vaccine; enforcing <code>INNER JOIN</code> will cause this data to be filtered out and not appear on the result set.</p>
<p>This approach shows 10 times improvement in comparison to the approach #1, but keep in mind that when returning a lot of columns you will get a lot of repeated data which translates into more network traffic.</p>
<h3 id="approach-3-json-aggregates">Approach 3: Json aggregates</h3>
<p>This approach takes the previous one (keeping the joins) but using json arrays for each of the data points that have a relationship 1 to N with <code>person</code> in order to avoid repeatable rows.</p>
<ul>
<li>A json array for animals (can be more than one)</li>
<li>A json array for animal vaccines (an animal can have one or more than one vaccine)</li>
<li>A json array for vaccines (a person can have N animals and each animal can have N vaccines)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#eceff4">.</span>id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    json_agg<span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">DISTINCT</span> to_jsonb<span style="color:#eceff4">(</span>a<span style="color:#eceff4">.</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1;font-weight:bold">AS</span> animals<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    json_agg<span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">DISTINCT</span> to_jsonb<span style="color:#eceff4">(</span>av<span style="color:#eceff4">.</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1;font-weight:bold">AS</span> animal_vaccine<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    json_agg<span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">DISTINCT</span> to_jsonb<span style="color:#eceff4">(</span>v<span style="color:#eceff4">.</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1;font-weight:bold">AS</span> vaccine
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> person p
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">LEFT</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> animal a <span style="color:#81a1c1;font-weight:bold">ON</span> p<span style="color:#eceff4">.</span>id <span style="color:#81a1c1">=</span> a<span style="color:#eceff4">.</span>owner_id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">LEFT</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> animal_vaccine av <span style="color:#81a1c1;font-weight:bold">ON</span> av<span style="color:#eceff4">.</span>animal_id <span style="color:#81a1c1">=</span> a<span style="color:#eceff4">.</span>id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">LEFT</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> vaccine v <span style="color:#81a1c1;font-weight:bold">ON</span> av<span style="color:#eceff4">.</span>vaccine_id <span style="color:#81a1c1">=</span> v<span style="color:#eceff4">.</span>id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> p<span style="color:#eceff4">.</span>name <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;Pablo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">GROUP</span> <span style="color:#81a1c1;font-weight:bold">BY</span> p<span style="color:#eceff4">.</span>id<span style="color:#eceff4">,</span> p<span style="color:#eceff4">.</span>name
</span></span></code></pre></div><p>Breaking it:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>json_agg<span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">DISTINCT</span> to_jsonb<span style="color:#eceff4">(</span>a<span style="color:#eceff4">.</span><span style="color:#81a1c1">*</span><span style="color:#eceff4">))</span> <span style="color:#81a1c1;font-weight:bold">AS</span> animals
</span></span></code></pre></div><p>This will return a json array <code>[...]</code>, on which each row will be returned as a json object (using the column name as json properties) and applying it a <code>DISTINCT</code> to discard repeated results. As we saw on the approach #2, an animal will appear for each vaccine it has received. The distinct filters out that repeated data.</p>
<p>Also the <code>GROUP BY p.id, p.name</code> is used to make sure the person is returned only once as well.</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>animals</th>
<th>animal_vaccine</th>
<th>vaccine</th>
</tr>
</thead>
<tbody>
<tr>
<td>fbab22a3-f7bc-422c-942f-d184ad189e29</td>
<td>Pablo</td>
<td>[{&ldquo;id&rdquo;: &ldquo;5f2461a9-6c62-453e-9182-38cd0fa76e01&rdquo;, &ldquo;name&rdquo;: &ldquo;Bills&rdquo;, &ldquo;type&rdquo;: &ldquo;cat&rdquo;, &ldquo;owner_id&rdquo;: &ldquo;fbab22a3-f7bc-422c-942f-d184ad189e29&rdquo;}]</td>
<td>[{&ldquo;animal_id&rdquo;: &ldquo;5f2461a9-6c62-453e-9182-38cd0fa76e01&rdquo;, &ldquo;applied_on&rdquo;: &ldquo;2021-02-10T00:00:00&rdquo;, &ldquo;vaccine_id&rdquo;: &ldquo;0ee28253-5b94-4096-926c-d33ceb22d24d&rdquo;}, {&ldquo;animal_id&rdquo;: &ldquo;5f2461a9-6c62-453e-9182-38cd0fa76e01&rdquo;, &ldquo;applied_on&rdquo;: &ldquo;2022-02-10T00:00:00&rdquo;, &ldquo;vaccine_id&rdquo;: &ldquo;6cf5487a-ba06-42e7-9e80-226590752a77&rdquo;}]</td>
<td>[{&ldquo;id&rdquo;: &ldquo;0ee28253-5b94-4096-926c-d33ceb22d24d&rdquo;, &ldquo;name&rdquo;: &ldquo;Feline herpesvirus&rdquo;}, {&ldquo;id&rdquo;: &ldquo;6cf5487a-ba06-42e7-9e80-226590752a77&rdquo;, &ldquo;name&rdquo;: &ldquo;Rabies&rdquo;}]</td>
</tr>
</tbody>
</table>
<p>This surely looks messy at first, but you can compare it with the approach #1.5. The mentioned one relied on receiving list of animals and vaccines, but it was a single list for all the people filtered out, in this case the list of animals and vaccines belong to the person on whose row is being iterated.</p>
<p>For each person:</p>
<ul>
<li>Deserialize animals.</li>
<li>Deserialize vaccines.</li>
<li>Deserialize animal vaccines.</li>
</ul>
<p>In golang, these arrays can be represented as <code>[]byte</code> so each one could be used as input for deserializing into a structure with the corresponding fields.</p>
<p>Migrating from approach #1 to approach #3 showed improvements between 10x and 15x.</p>
<h3 id="bonus-approach-doing-the-mapping-on-postgres---but-are-you-sure-you-want-to-do-this">Bonus approach: Doing the mapping on Postgres - but are you sure you want to do this?</h3>
<p>In the approaches above, different ways to fetch data were described, but the mapping ocurred somewhere in the code that executes these queries. Is it possible to do the required mapping using Postgres?</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span>
</span></span><span style="display:flex;"><span>    jsonb_build_object<span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a3be8c">&#39;id&#39;</span><span style="color:#eceff4">,</span> p<span style="color:#eceff4">.</span>id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a3be8c">&#39;name&#39;</span><span style="color:#eceff4">,</span> p<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a3be8c">&#39;animals&#39;</span><span style="color:#eceff4">,</span> <span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#81a1c1;font-weight:bold">SELECT</span> json_agg<span style="color:#eceff4">(</span>jsonb_build_object<span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a3be8c">&#39;id&#39;</span><span style="color:#eceff4">,</span> a<span style="color:#eceff4">.</span>id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a3be8c">&#39;type&#39;</span><span style="color:#eceff4">,</span> a<span style="color:#eceff4">.</span><span style="color:#81a1c1;font-weight:bold">type</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a3be8c">&#39;name&#39;</span><span style="color:#eceff4">,</span> a<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a3be8c">&#39;vaccines&#39;</span><span style="color:#eceff4">,</span> <span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#81a1c1;font-weight:bold">SELECT</span> json_agg<span style="color:#eceff4">(</span>jsonb_build_object<span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a3be8c">&#39;id&#39;</span><span style="color:#eceff4">,</span> v<span style="color:#eceff4">.</span>id<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a3be8c">&#39;name&#39;</span><span style="color:#eceff4">,</span> v<span style="color:#eceff4">.</span>name<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a3be8c">&#39;applied_on&#39;</span><span style="color:#eceff4">,</span> av<span style="color:#eceff4">.</span>applied_on
</span></span><span style="display:flex;"><span>                    <span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#81a1c1;font-weight:bold">FROM</span> animal_vaccine av
</span></span><span style="display:flex;"><span>                    <span style="color:#81a1c1;font-weight:bold">INNER</span> <span style="color:#81a1c1;font-weight:bold">JOIN</span> vaccine v <span style="color:#81a1c1;font-weight:bold">ON</span> av<span style="color:#eceff4">.</span>vaccine_id <span style="color:#81a1c1">=</span> v<span style="color:#eceff4">.</span>id
</span></span><span style="display:flex;"><span>                    <span style="color:#81a1c1;font-weight:bold">WHERE</span> av<span style="color:#eceff4">.</span>animal_id <span style="color:#81a1c1">=</span> a<span style="color:#eceff4">.</span>id
</span></span><span style="display:flex;"><span>                <span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#81a1c1;font-weight:bold">FROM</span> animal a <span style="color:#81a1c1;font-weight:bold">WHERE</span> a<span style="color:#eceff4">.</span>owner_id <span style="color:#81a1c1">=</span> p<span style="color:#eceff4">.</span>id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> person p
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> p<span style="color:#eceff4">.</span>name <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;Pablo&#39;</span>
</span></span></code></pre></div><p>And the answer is yes. The query above, uses the function <code>jsonb_build_object</code> for creating a json object with named properties (vs <code>row_to_jsonb</code> which just took the <code>*</code> operator); and the <code>json_agg</code> is used for the relationships that are 1 to N.</p>
<p>For each nested object, a sub query is performed to fetch the relevant data, which gets rid of <code>LEFT JOIN</code> and also <code>GROUP BY</code> (that also gets rid of inherent sorting)</p>
<p>This returns:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#bf616a">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;id&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;fbab22a3-f7bc-422c-942f-d184ad189e29&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;name&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;Pablo&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;animals&#34;</span><span style="color:#eceff4">:</span> <span style="color:#eceff4">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#bf616a">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">&#34;id&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;5f2461a9-6c62-453e-9182-38cd0fa76e01&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">&#34;name&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;Bills&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">&#34;type&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;cat&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">&#34;vaccines&#34;</span><span style="color:#eceff4">:</span> <span style="color:#eceff4">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#bf616a">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a3be8c">&#34;id&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;0ee28253-5b94-4096-926c-d33ceb22d24d&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a3be8c">&#34;name&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;Feline herpesvirus&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a3be8c">&#34;applied_on&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;2021-02-10T00:00:00&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#bf616a">}</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#bf616a">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a3be8c">&#34;id&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;6cf5487a-ba06-42e7-9e80-226590752a77&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a3be8c">&#34;name&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;Rabies&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a3be8c">&#34;applied_on&#34;</span><span style="color:#eceff4">:</span> <span style="color:#a3be8c">&#34;2022-02-10T00:00:00&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#bf616a">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#eceff4">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#bf616a">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">]</span>
</span></span><span style="display:flex;"><span><span style="color:#bf616a">}</span>
</span></span></code></pre></div><p>Postgres, and some other databases, evolved a lot throughout time and are very capable of dealing with json types already. Under certain circumstances a query like the one above can be very useful.</p>
<p>However, keep in mind that doing this could cause the service to have a high coupling between the API model and the database queries; and a change of how you want the response to look like, may affect the way you execute a query.</p>
<h3 id="bottom-line">Bottom line</h3>
<ul>
<li>Postgres is very powerful, it is always useful to keep yourself up to date at least knowing what features are available, even when you don&rsquo;t know the specifics.</li>
<li>Keep in mind simplicity and try to improve as the system requires it.</li>
<li>Do not favor premature optimization just for exploration reasons, but don&rsquo;t be afraid to explore and think out of the box when needed.</li>
</ul>

    </div>
  </article>

  <hr />

  <div class="post-info">
    
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://devandchill.com/tags/postgres/">postgres</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/array/">array</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/aggregations/">aggregations</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/query/">query</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/json/">json</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/performance/">performance</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/optimization/">optimization</a></span>
        
    </p>

    

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-file-text">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      1582 Words
    </p>

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-calendar">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      
      2021-03-21 12:31 &#43;0100
      

      
      
      
    </p>
  </div>

  
  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">Read other posts</span>
      <hr />
    </div>

    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://devandchill.com/posts/2021/04/introducing-maybe-package-bring-functional-to-go/">
          <span class="button__icon">←</span>
          <span class="button__text">Introducing Maybe package, bring functional to Go</span>
        </a>
      </span>
      

      
      <span class="button next">
        <a href="https://devandchill.com/posts/2020/11/the-good-the-bad-and-the-ugly-of-microservices/">
          <span class="button__text">The good, the bad and the ugly of microservices</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  
  

  
  

</main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        


<script type="text/javascript" src="/bundle.min.69fb501ac7bace7c0ca982d98573883fe084cb258084917289a51bc0bc04868a1b91b95a34c641d2854f64b4b0245430430f86fa70e19f7425062100c9b69215.js" integrity="sha512-aftQGse6znwMqYLZhXOIP&#43;CEyyWAhJFyiaUbwLwEhoobkblaNMZB0oVPZLSwJFQwQw&#43;G&#43;nDhn3QlBiEAybaSFQ=="></script>



    </body>
</html>
