<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Pablo Morelli">
<meta name="description" content="Devandchill is a coding blog where I share my ideas and insights on various programming topics." />
<meta name="keywords"
    content="blog, development, programming, tech, go, opentracing, opentelemetry, tracing, telemetry, jaeger" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://devandchill.com/posts/2021/12/go-step-by-step-guide-for-implementing-tracing-on-a-microservices-architecture-1/2/" />


<title>
    
    Go - Step by step guide for implementing tracing on a microservices architecture (1/2) :: Dev &amp; Chill  — A blog about coding
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" type="text/css" href="/main.045f18da88f8cb42336977558c8919c77ba0afb78827b7a1250d971d6cfd080e.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Go - Step by step guide for implementing tracing on a microservices architecture (1/2)">
<meta itemprop="description" content="This article is the first of a series of two. In this first one we are going to talk about what is tracing is used for, the scope of this proof of concept and implement the first service.
What is the problem? Nowadays everyone wants to do microservices, it is a buzzword on every tech start up and while it brings a lot of benefits into the table it also brings some drawbacks that not everyone is aware at first."><meta itemprop="datePublished" content="2021-12-03T13:00:00+02:00" />
<meta itemprop="dateModified" content="2021-12-03T13:00:00+02:00" />
<meta itemprop="wordCount" content="2703"><meta itemprop="image" content="https://devandchill.com/og-image.png"/>
<meta itemprop="keywords" content="go,opentracing,opentelemetry,tracing,telemetry,jaeger," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://devandchill.com/og-image.png"/>

<meta name="twitter:title" content="Go - Step by step guide for implementing tracing on a microservices architecture (1/2)"/>
<meta name="twitter:description" content="This article is the first of a series of two. In this first one we are going to talk about what is tracing is used for, the scope of this proof of concept and implement the first service.
What is the problem? Nowadays everyone wants to do microservices, it is a buzzword on every tech start up and while it brings a lot of benefits into the table it also brings some drawbacks that not everyone is aware at first."/>







<meta property="article:published_time" content="2021-12-03 13:00:00 &#43;0200 &#43;0200" />







<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138171880-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138171880-1');
</script>



    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <img src="/dev-n-chill-logo.svg" alt="Dev &amp; Chill" />
        
    </div>
</a>


        <span class="header__right">
            
            <nav class="menu">
    <ul class="menu__inner"><li><a href="/blog">The blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/posts">Posts</a></li>
    </ul>
</nav>

            <span class="menu-trigger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">

  <div class="post-info">
    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-clock">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      13 minutes

      
    </p>
  </div>

  <article>
    <h1 class="post-title">
      <a href="https://devandchill.com/posts/2021/12/go-step-by-step-guide-for-implementing-tracing-on-a-microservices-architecture-1/2/">Go - Step by step guide for implementing tracing on a microservices architecture (1/2)</a>
    </h1>

    

    

    

    <div class="post-content">
      <p>This article is the first of a series of two. In this first one we are going to talk about what is tracing is used for, the scope of this proof of concept and implement the first service.</p>
<h3 id="what-is-the-problem">What is the problem?</h3>
<p>Nowadays everyone wants to do microservices, it is a buzzword on every tech start up and while it brings a lot of benefits into the table it also brings some drawbacks that not everyone is aware at first.</p>
<h4 id="logging">Logging</h4>
<p>When working with a monolith, logs are quite simple because the journey is usually auto-conclusive. An HTTP request in most cases ends up with a call to a database or to another external API. This is quite simple to follow and also to log.</p>
<p>When working with microservices, this is not true. A HTTP request can end up communicating with a lot of other internal services and via different protocols. Logging here is quite expensive if you consider logging an entry for each HTTP request and response a service receives.</p>
<p>Fortunately there are logs aggregators that allow developers to query on different logs of different applications all on the same bucket. Even though storage is not expensive, these solutions end up charging a lot due to the computational power needed to query on those. In GCP 1 TB of data costs approx 490 USD per month at the time writing.</p>
<p>Now imagine producing 1 TB of data per month, but actually storing 3 months of data. The price estimate then goes up to 1511 USD per month. Had you ask yourself how long do you need the logs? What are the use case for those?</p>
<p>Last but not least, security. What data is compliance for you to log? Should you log requests and responses? Probably not, but again depends on the company you are working with and what are the needs.</p>
<p>What if there was a way to make cost smaller without losing the traceability of the logs?</p>
<h4 id="user-journeys">User journeys</h4>
<p>Had you ever heard the quote: &ldquo;but it works on my machine&rdquo;? I remember once a microservice based system that worked on a stage environment but when tested with real user load it was as slow as a turtle.</p>
<p>Sometimes when working with microservices, and when there are lots of them, one can feel inclined to say &ldquo;let&rsquo;s do a request to this one&rdquo; to fetch a field that its needed. But then that microservice is doing a call to two other services, and these two are also doing the same.</p>
<p>When working without heavy load this may work fine, but what if the first microservice receives 100 calls in 5 seconds, how are the rest of the services going to handle the cascade effect?</p>
<p>Documenting a flow is really hard, and I will risk saying that is impossible to maintain. Developers come and go, there is not always someone maintaining the document, and when scaling up and adding a lot of new flows it becomes impossible to keep up to date.</p>
<p>What if there was a way to display on demand an entire user journey? This would allow developers to see effectively which services are involved on it and do refactors, or add new features being conscious about what services are going to be affected. This is also very useful when onboarding new people into the team as they can get the context faster.</p>
<h3 id="tracing">Tracing</h3>
<p>Tracing is our lord and saviour. It is the action of decorating a log with a trace ID so developers can correlate a user journey all together. Easy right?</p>
<p>This concept does not really depend on any specific tool, one could just do structured logging, add an ID and make sure that it gets propagated on subsequent logs. Then this is queryable on the log aggregator, but it does not solve the amount of logs stored nor help us visualize a flow.</p>
<p>Fortunately, there is a CNCF (Cloud Native Computing Foundation) project named <code>OpenTelemetry</code> that takes care of how the standard looks like, and provides libraries in different languages for people to use.</p>
<p>Using <code>OpenTelemetry</code> one can use tools that allow visualization such as <code>Jaeger</code>, <code>Zipkin</code> or <code>CloudTrace</code> on GCP (it is likely that other cloud providers are also offering their own solution). Also these are stored as metrics instead of logs and this reduces the cost further. For example, in GCP storing 100 million of spans cost 20 USD. That is basically 100 million calls in the system.</p>
<p>Think of the trace as a distributed transaction. Each user journey will have a trace, and the trace will contain 1 to N spans. A span is basically an operation that happened in that trace. It can be an HTTP call, consuming an AMQP message, calling to a database.</p>
<p>A span contains a name, an originating service, and it can contain error traces, or any field that is needed to add.</p>
<h3 id="proof-of-concept">Proof of concept</h3>
<p>In order to show the capabilities of tracing with <code>OpenTelemetry</code> a very simplified checkout domain is going to be used. The following is going to use different communication protocols such as HTTP, gRPC and AMQP. The use case is:</p>
<p><em>There is a <code>checkout-gateway</code> that receives and validates HTTP requests from a frontend when a customer wants to finalize the payment. The frontend will be simulated via a cURL request.</em>
<em>The gateway communicates via gRPC with the <code>checkout-service</code>. This service will do some processing and when it is done it will publish an AMQP message which name is <code>checkout.processed</code>.</em>
<em>The mentioned message is consumed with the <code>stock-service</code> that will adjust the stock quantities.</em></p>
<figure><img src="/posts/images/checkout_user_journey.svg"
         alt="checkout-user-journey"/>
</figure>

<p>In order to keep things simple, the gateway validation, the checkout processing and the stock adjustment of quantities is going to be ignored. The only important part here is to generate the trace and to propagate via different transports.</p>
<p>It is also worth mentioning that this is an intended oversimplification and not how a real checkout domain should look.</p>
<p>Some concepts such as gRPC, Dockerfile, docker-compose and AMQP will be shown but not explained fully, if these are new to you, please refer to the documentation before using them in a work environment.</p>
<p>Three microservices and two additional libraries will be used for this example, and to keep things simple they will be under the same repository.</p>
<blockquote>
<p>If using VS Code, make sure to enable multiple workspaces so <code>gopls</code> will not throw an error about having multiple module files (one for each folder). <a href="https://code.visualstudio.com/docs/editor/multi-root-workspaces"  target="_blank" rel="noreferrer noopener" >More info here.</a>
</p>
</blockquote>
<h3 id="introducing-jaeger">Introducing Jaeger</h3>
<p>Jaeger is an open tracing tool that let us monitor and troubleshoot distributed transactions. It is also a project from CNCF. For an easy start up, it provides a docker image that contains the UI, collector, query, and agent, with an in memory storage component.</p>
<p>Create a repository and in the root add the <code>docker-compose.yaml</code>. In this file we are going to add all the services, but for now let&rsquo;s add Jaeger:</p>
<pre tabindex="0"><code>version: &#34;3.9&#34;
services:
  jaeger:
    image: &#34;jaegertracing/all-in-one:latest&#34;
    ports:
      - &#34;16686:16686&#34;
      - &#34;6831:6831&#34;
</code></pre><p><a href="https://github.com/pmorelli92/open-telemetry-go/commit/31457bb80870ad9e4ae3e6fbe193b9068520d73a"  target="_blank" rel="noreferrer noopener" >👉 Commit reference 👈</a>
</p>
<h3 id="adding-the-proto-library">Adding the proto library</h3>
<p>The <code>checkout-gateway</code> will communicate with the <code>checkout-service</code> and this is going to happen with gRPC. For this we need to define the proto files for both the client and the server. In the root of the repository create a folder named <code>proto</code> and inside the folder execute:</p>
<p><em>NOTE: For all the upcoming go module initialization remember to replace the text above with the path to your repository.</em></p>
<pre tabindex="0"><code>go mod init github.com/pmorelli92/open-telemetry-go/proto
</code></pre><p>In both the gateway and checkout we are going to reference to this library, so that is why each service will have a different ending <code>/</code> to differentiate them.</p>
<p>Now create a <code>checkout.proto</code> file in the folder with the following content:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-proto" data-lang="proto"><span style="display:flex;"><span>syntax <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#34;proto3&#34;</span><span style="color:#eceff4">;</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">option</span> go_package <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#34;github.com/pmorelli92/open-telemetry-go/proto&#34;</span><span style="color:#eceff4">;</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">package</span> <span style="color:#8fbcbb">checkout</span><span style="color:#eceff4">;</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">service</span> Checkout <span style="color:#eceff4">{</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span>  <span style="color:#81a1c1;font-weight:bold">rpc</span> DoCheckout <span style="color:#eceff4">(</span>CheckoutRequest<span style="color:#eceff4">)</span> <span style="color:#81a1c1;font-weight:bold">returns</span> <span style="color:#eceff4">(</span>CheckoutResponse<span style="color:#eceff4">)</span> <span style="color:#eceff4">{}</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#eceff4">}</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">message</span> <span style="color:#8fbcbb">CheckoutRequest</span> <span style="color:#eceff4">{</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span>  <span style="color:#81a1c1;font-weight:bold">repeated</span> <span style="color:#81a1c1">int32</span> itemsID <span style="color:#81a1c1">=</span> <span style="color:#b48ead">1</span><span style="color:#eceff4">;</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#eceff4">}</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">message</span> <span style="color:#8fbcbb">CheckoutResponse</span> <span style="color:#eceff4">{</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span>  <span style="color:#81a1c1">int32</span> totalAmount <span style="color:#81a1c1">=</span> <span style="color:#b48ead">1</span><span style="color:#eceff4">;</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#eceff4">}</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>Out of this proto file some golang structures are going to be generated such as a <code>CheckoutClient</code>, <code>CheckoutServer</code>, <code>CheckoutRequest</code> and <code>CheckoutResponse</code>. In the <code>proto</code> folder execute:</p>
<p><em>NOTE: In order to execute the line below you need to install the proto generator tool: <code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code>.</em></p>
<pre tabindex="0"><code>protoc --go-grpc_out=. --go_out=. --go-grpc_opt=paths=source_relative --go_opt=paths=source_relative checkout.proto &amp;&amp; go mod tidy
</code></pre><p>After running this command, you should have the files <code>checkout.pb.go</code> and <code>checkout_grpc.pb.go</code>. Commit and push these files so they are available for getting them as dependency.</p>
<p><a href="https://github.com/pmorelli92/open-telemetry-go/commit/6b424d630c69bc6755673c5a3e8732e309589079"  target="_blank" rel="noreferrer noopener" >👉 Commit reference 👈</a>
</p>
<h3 id="adding-the-utils-library">Adding the utils library</h3>
<p>Some of the functions that are going to be used will be repeated throughout all the services. Things such as parsing an environment variable, injecting AMQP headers and getting an AMQP connection. In an enterprise environment one can take decisions as repeating the few lines of coding instead of adding a dependency, or split the dependencies in different libraries.</p>
<p>In order to keep things simple, only one library is going to be used here. In the root of the repository create a folder named <code>utils</code> and inside the folder execute:</p>
<pre tabindex="0"><code>go mod init github.com/pmorelli92/open-telemetry-go/utils
</code></pre><p>Create a file named <code>env.go</code>. This file will contain the <code>EnvString</code> function that will parse an environment variable to fetch the value. If this one is not set, it will fallback to a default value.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">package</span> utils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">import</span> <span style="color:#a3be8c">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">EnvString</span><span style="color:#eceff4">(</span>key<span style="color:#eceff4">,</span> fallback <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">string</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> value<span style="color:#eceff4">,</span> ok <span style="color:#81a1c1">:=</span> syscall<span style="color:#eceff4">.</span><span style="color:#88c0d0">Getenv</span><span style="color:#eceff4">(</span>key<span style="color:#eceff4">);</span> ok <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> value
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Create another file named <code>tracer.go</code> and add the <code>SetGlobalTracer</code> function shown below. This function will do several things:</p>
<ul>
<li><strong>Set up a jaeger exporter:</strong> This one has to be aware of the endpoint where the agent is running. This data is supplied by parameter.</li>
<li><strong>Set up the trace provider:</strong> This is set up in a global scope so it is not returned by the function. The trace provider comes from the OpenTelemetry library and uses the exporter that satisfies the interface which OpenTelemetry expects.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">package</span> utils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">import</span> <span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;go.opentelemetry.io/otel&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;go.opentelemetry.io/otel/exporters/jaeger&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;go.opentelemetry.io/otel/propagation&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;go.opentelemetry.io/otel/sdk/resource&#34;</span>
</span></span><span style="display:flex;"><span>	tracesdk <span style="color:#a3be8c">&#34;go.opentelemetry.io/otel/sdk/trace&#34;</span>
</span></span><span style="display:flex;"><span>	semconv <span style="color:#a3be8c">&#34;go.opentelemetry.io/otel/semconv/v1.4.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">SetGlobalTracer</span><span style="color:#eceff4">(</span>serviceName <span style="color:#81a1c1">string</span><span style="color:#eceff4">,</span> exporterAddress <span style="color:#81a1c1">string</span><span style="color:#eceff4">,</span> exporterPort <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">error</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	exporter<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> jaeger<span style="color:#eceff4">.</span><span style="color:#88c0d0">New</span><span style="color:#eceff4">(</span>jaeger<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithAgentEndpoint</span><span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>		jaeger<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithAgentHost</span><span style="color:#eceff4">(</span>exporterAddress<span style="color:#eceff4">),</span>
</span></span><span style="display:flex;"><span>		jaeger<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithAgentPort</span><span style="color:#eceff4">(</span>exporterPort<span style="color:#eceff4">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tp <span style="color:#81a1c1">:=</span> tracesdk<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewTracerProvider</span><span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>		tracesdk<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithBatcher</span><span style="color:#eceff4">(</span>exporter<span style="color:#eceff4">),</span>
</span></span><span style="display:flex;"><span>		tracesdk<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithResource</span><span style="color:#eceff4">(</span>resource<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewWithAttributes</span><span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>			semconv<span style="color:#eceff4">.</span>SchemaURL<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>			semconv<span style="color:#eceff4">.</span>ServiceNameKey<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">(</span>serviceName<span style="color:#eceff4">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">)),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	otel<span style="color:#eceff4">.</span><span style="color:#88c0d0">SetTracerProvider</span><span style="color:#eceff4">(</span>tp<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	otel<span style="color:#eceff4">.</span><span style="color:#88c0d0">SetTextMapPropagator</span><span style="color:#eceff4">(</span>propagation<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewCompositeTextMapPropagator</span><span style="color:#eceff4">(</span>propagation<span style="color:#eceff4">.</span>TraceContext<span style="color:#eceff4">{}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Running a <code>go mod tidy</code> should fetch all the dependencies required. For now this is all needed, commit and push.</p>
<p><a href="https://github.com/pmorelli92/open-telemetry-go/commit/0025c709fc1f018d22261681bf473561cd9a4257"  target="_blank" rel="noreferrer noopener" >👉 Commit reference 👈</a>
</p>
<h3 id="the-gateway">The gateway</h3>
<p>This component is pretty straightforward. It should expose an HTTP server with the <code>/api/checkout</code> endpoint and communicate with the checkout service via gRPC. It will also set up the global tracer using the function defined above.</p>
<p>In order to do these things some environment variables are going to be used:</p>
<ul>
<li>JAEGER_ADDRESS</li>
<li>JAEGER_PORT</li>
<li>HTTP_ADDRESS</li>
<li>CHECKOUT_SERVICE_ADDRESS</li>
</ul>
<p>Create a folder named <code>gateway</code> and inside it, initialize go mod and add the dependency to both the <code>proto</code> and <code>utils</code> package:</p>
<pre tabindex="0"><code>go mod init github.com/pmorelli92/open-telemetry-go/gateway
go get github.com/pmorelli92/open-telemetry-go/proto
go get github.com/pmorelli92/open-telemetry-go/utils
</code></pre><p>Inside the folder create the <code>main.go</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">import</span> <span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;github.com/pmorelli92/open-telemetry-go/utils&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">main</span><span style="color:#eceff4">()</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	jaegerAddress <span style="color:#81a1c1">:=</span> utils<span style="color:#eceff4">.</span><span style="color:#88c0d0">EnvString</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;JAEGER_ADDRESS&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;localhost&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	jaegerPort <span style="color:#81a1c1">:=</span> utils<span style="color:#eceff4">.</span><span style="color:#88c0d0">EnvString</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;JAEGER_PORT&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;6831&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	checkoutAddress <span style="color:#81a1c1">:=</span> utils<span style="color:#eceff4">.</span><span style="color:#88c0d0">EnvString</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;CHECKOUT_SERVICE_ADDRESS&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;localhost:8080&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	httpAddress <span style="color:#81a1c1">:=</span> utils<span style="color:#eceff4">.</span><span style="color:#88c0d0">EnvString</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;HTTP_ADDRESS&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;:8081&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err <span style="color:#81a1c1">:=</span> utils<span style="color:#eceff4">.</span><span style="color:#88c0d0">SetGlobalTracer</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;gateway&#34;</span><span style="color:#eceff4">,</span> jaegerAddress<span style="color:#eceff4">,</span> jaegerPort<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Fatalf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;failed to create tracer: %v&#34;</span><span style="color:#eceff4">,</span> err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// Add GRPC
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#616e87;font-style:italic">// Add HTTP
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>So far, the code is just parsing the environment variables and invoking the <code>SetGlobalTracer</code> supplying the service name and the agent endpoint. Then, replace the <code>// Add GRPC</code> comment with the following content:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>conn<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> grpc<span style="color:#eceff4">.</span><span style="color:#88c0d0">Dial</span><span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>	checkoutAddress<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>	grpc<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithInsecure</span><span style="color:#eceff4">(),</span>
</span></span><span style="display:flex;"><span>	grpc<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithUnaryInterceptor</span><span style="color:#eceff4">(</span>otelgrpc<span style="color:#eceff4">.</span><span style="color:#88c0d0">UnaryClientInterceptor</span><span style="color:#eceff4">()),</span>
</span></span><span style="display:flex;"><span>	grpc<span style="color:#eceff4">.</span><span style="color:#88c0d0">WithStreamInterceptor</span><span style="color:#eceff4">(</span>otelgrpc<span style="color:#eceff4">.</span><span style="color:#88c0d0">StreamClientInterceptor</span><span style="color:#eceff4">()))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Fatalf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;did not connect: %v&#34;</span><span style="color:#eceff4">,</span> err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">defer</span> conn<span style="color:#eceff4">.</span><span style="color:#88c0d0">Close</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>c <span style="color:#81a1c1">:=</span> pb<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewCheckoutClient</span><span style="color:#eceff4">(</span>conn<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>There are two unsolved references:</p>
<ul>
<li><code>otelgrpc</code> which is a library that enables the propagation of a trace via gRPC protocol.  This means that when frontend calls the gateway and the trace is created, this library, using the <code>ctx</code>, will propagate the trace via gRPC to the checkout service. To reference this library run:</li>
</ul>
<pre tabindex="0"><code>go get go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc
</code></pre><ul>
<li>The other unsolved reference is <code>pb</code> that prefixes the <code>NewCheckoutClient</code>. As mentioned before, this code is generated on the proto module. Just add on the imports:</li>
</ul>
<pre tabindex="0"><code>pb &#34;github.com/pmorelli92/open-telemetry-go/proto&#34;
</code></pre><p>Lastly, replace the <code>Add HTTP</code> comment with the following content:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">// HTTP config
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>router <span style="color:#81a1c1">:=</span> http<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewServeMux</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>router<span style="color:#eceff4">.</span><span style="color:#88c0d0">HandleFunc</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;/api/checkout&#34;</span><span style="color:#eceff4">,</span> <span style="color:#88c0d0">checkoutHandler</span><span style="color:#eceff4">(</span>c<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;HTTP server listening at &#34;</span><span style="color:#eceff4">,</span> httpAddress<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>log<span style="color:#eceff4">.</span><span style="color:#88c0d0">Fatal</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span><span style="color:#88c0d0">ListenAndServe</span><span style="color:#eceff4">(</span>httpAddress<span style="color:#eceff4">,</span> router<span style="color:#eceff4">))</span>
</span></span></code></pre></div><p>This piece of code is creating a router and starting the HTTP server. It is also defining that for the route <code>/api/checkout</code> it is going to use the <code>checkoutHandler</code> that will take the checkout gRPC client as parameter. The checkout handler looks as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">checkoutHandler</span><span style="color:#eceff4">(</span>c pb<span style="color:#eceff4">.</span>CheckoutClient<span style="color:#eceff4">)</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>ResponseWriter<span style="color:#eceff4">,</span> <span style="color:#81a1c1">*</span>http<span style="color:#eceff4">.</span>Request<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">(</span>w http<span style="color:#eceff4">.</span>ResponseWriter<span style="color:#eceff4">,</span> r <span style="color:#81a1c1">*</span>http<span style="color:#eceff4">.</span>Request<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Allow only POST
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>		<span style="color:#81a1c1;font-weight:bold">if</span> r<span style="color:#eceff4">.</span>Method <span style="color:#81a1c1">!=</span> http<span style="color:#eceff4">.</span>MethodPost <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusMethodNotAllowed<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Create a tracer span
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>		tr <span style="color:#81a1c1">:=</span> otel<span style="color:#eceff4">.</span><span style="color:#88c0d0">Tracer</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;http&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		ctx<span style="color:#eceff4">,</span> span <span style="color:#81a1c1">:=</span> tr<span style="color:#eceff4">.</span><span style="color:#88c0d0">Start</span><span style="color:#eceff4">(</span>r<span style="color:#eceff4">.</span><span style="color:#88c0d0">Context</span><span style="color:#eceff4">(),</span> fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;%s %s&#34;</span><span style="color:#eceff4">,</span> r<span style="color:#eceff4">.</span>Method<span style="color:#eceff4">,</span> r<span style="color:#eceff4">.</span>RequestURI<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">defer</span> span<span style="color:#eceff4">.</span><span style="color:#88c0d0">End</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Make the GRPC call to checkout-service
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>		_<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> c<span style="color:#eceff4">.</span><span style="color:#88c0d0">DoCheckout</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>pb<span style="color:#eceff4">.</span>CheckoutRequest<span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			ItemsID<span style="color:#eceff4">:</span> <span style="color:#eceff4">[]</span><span style="color:#81a1c1">int32</span><span style="color:#eceff4">{</span><span style="color:#b48ead">1</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">2</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">3</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">4</span><span style="color:#eceff4">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Check for errors
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>		rStatus <span style="color:#81a1c1">:=</span> status<span style="color:#eceff4">.</span><span style="color:#88c0d0">Convert</span><span style="color:#eceff4">(</span>err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">if</span> rStatus <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			span<span style="color:#eceff4">.</span><span style="color:#88c0d0">SetStatus</span><span style="color:#eceff4">(</span>codes<span style="color:#eceff4">.</span>Error<span style="color:#eceff4">,</span> err<span style="color:#eceff4">.</span><span style="color:#88c0d0">Error</span><span style="color:#eceff4">())</span>
</span></span><span style="display:flex;"><span>			w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusInternalServerError<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Success
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>		w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusAccepted<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>The only thing that may look unfamiliar here is the creation of a trace. As mentioned before, the trace is the distributed transaction. It will be created wherever the user journey starts and be propagated until the user journey ends. In order to create a trace one needs a <code>Tracer</code> that will be provided by the global tracing provider that the <code>utils.SetGlobalTracer</code> set for us.</p>
<p>Generating a trace with result in two things, the distributed transaction being created and a first child called <code>Span</code>. Each span represents an operation and a trace an have N of them. A span will have a start and close time (and hence a duration).</p>
<p>After the call to the gRPC server is done, if it returned an error then <code>span.SetStatus(codes.Error, err.Error())</code> is invoked. This means that the span will be aware of the operation failing. Some information of the error is also stored for easiness to troubleshoot what happened.</p>
<p>Code is then finished, now add a Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span><span style="color:#a3be8c"> golang:alpine3.14 AS compiler</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">RUN</span> apk --update --no-cache add git<span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">WORKDIR</span><span style="color:#a3be8c"> /gateway</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">ADD</span> go.mod go.sum ./<span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">RUN</span> go mod download<span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">ADD</span> . .<span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">RUN</span> CGO_ENABLED<span style="color:#81a1c1">=</span><span style="color:#b48ead">0</span> go build -o /bin/goapp ./main.go<span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">FROM</span><span style="color:#a3be8c"> scratch</span><span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">COPY</span> --from<span style="color:#81a1c1">=</span>compiler /bin/goapp /gateway<span style="color:#bf616a">
</span></span></span><span style="display:flex;"><span><span style="color:#bf616a"></span><span style="color:#81a1c1;font-weight:bold">ENTRYPOINT</span> <span style="color:#eceff4">[</span><span style="color:#a3be8c">&#34;/gateway&#34;</span><span style="color:#eceff4">]</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>Back on the root of the repository, add the service to the <code>docker-compose.yaml</code>:</p>
<pre tabindex="0"><code class="language-docker-compose" data-lang="docker-compose">version: &#34;3.9&#34;
services:
  jaeger:
    image: &#34;jaegertracing/all-in-one:latest&#34;
    ports:
      - &#34;16686:16686&#34;
      - &#34;6831:6831&#34;
  gateway:
    build:
      context: gateway
    restart: on-failure
    ports:
      - &#34;8081:8081&#34;
    environment:
      - JAEGER_ADDRESS=jaeger
      - JAEGER_PORT=6831
      - PRIVATE_LOAN_APPLICATION_ADDRESS=checkout:8080
      - HTTP_ADDRESS=:8081
    depends_on:
      - jaeger
</code></pre><p>Execute <code>go mod tidy</code> and you are ready for a commit and push.</p>
<p><a href="https://github.com/pmorelli92/open-telemetry-go/commit/3051506744fa62c27cfa25df6490e01b6b77b1c0"  target="_blank" rel="noreferrer noopener" >👉 Commit reference 👈</a>
</p>
<h3 id="trying-things-out">Trying things out</h3>
<p>You should be able to start up both jaeger and the gateway executing from the root of the repository: <code>docker-compose up --build</code>. After the services are up and running you can try calling the gateway with cURL:</p>
<pre tabindex="0"><code>curl -v -X POST http://localhost:8081/api/checkout

&lt; HTTP/1.1 500 Internal Server Error
&lt; Date: Fri, 03 Dec 2021 17:43:49 GMT
&lt; Content-Length: 0
</code></pre><p>The response is 500 due to the checkout service not being up yet. But the trace should have been created, and with then two spans: one created with the trace and one with the gRPC client.</p>
<p>Go to <code>http://localhost:16686</code>, on the UI select the service <code>gateway</code> and click Find Traces. You should be able to see a trace, click on it to see more details:</p>
<figure><img src="/posts/images/trace-1.png"
         alt="tracing-details"/>
</figure>

<p>As mentioned before, the trace has two spans. Both of the spans are decorated with a red exclamation mark indicating the operation failed. The first one has it as it was added with the <code>span.SetStatus</code> function on the <code>checkoutHandler</code>. The second span has it as the gRPC call failed.</p>
<p>We can see that the trace has two spans. The first one is created manually on the <code>checkoutHandler</code> and the status is error due to the <code>span.SetStatus</code> function. The other span is created by the <code>otel</code> library and also contains an error.</p>
<p>You can try out to add more data to a span invoking <code>span.AddEvent</code>.</p>
<h3 id="summary">Summary</h3>
<p>In this first article we have done quite a lot from discussing what the problematic is, what tools do we have to solve it, and even implementing a service that uses tracing. In the second part we will implement the <code>checkout-service</code> and the <code>stock-service</code> and explore Jaeger a bit more. Stay tuned!</p>

    </div>
  </article>

  <hr />

  <div class="post-info">
    
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://devandchill.com/tags/go/">go</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/opentracing/">opentracing</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/opentelemetry/">opentelemetry</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/tracing/">tracing</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/telemetry/">telemetry</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/jaeger/">jaeger</a></span>
        
    </p>

    

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-file-text">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      2703 Words
    </p>

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-calendar">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      
      2021-12-03 12:00 &#43;0100
      

      
      
      
    </p>
  </div>

  
  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">Read other posts</span>
      <hr />
    </div>

    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://devandchill.com/posts/2021/12/go-step-by-step-guide-for-implementing-tracing-on-a-microservices-architecture-2/2/">
          <span class="button__icon">←</span>
          <span class="button__text">Go - Step by step guide for implementing tracing on a microservices architecture (2/2)</span>
        </a>
      </span>
      

      
      <span class="button next">
        <a href="https://devandchill.com/posts/2021/09/go-generate-and-serve-swagger-without-code-dependencies/">
          <span class="button__text">Go - Generate and serve swagger without code dependencies</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  
  

  
  

</main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        


<script type="text/javascript" src="/bundle.min.69fb501ac7bace7c0ca982d98573883fe084cb258084917289a51bc0bc04868a1b91b95a34c641d2854f64b4b0245430430f86fa70e19f7425062100c9b69215.js" integrity="sha512-aftQGse6znwMqYLZhXOIP&#43;CEyyWAhJFyiaUbwLwEhoobkblaNMZB0oVPZLSwJFQwQw&#43;G&#43;nDhn3QlBiEAybaSFQ=="></script>



    </body>
</html>
