<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Pablo Morelli">
<meta name="description" content="Devandchill is a coding blog where I share my ideas and insights on various programming topics." />
<meta name="keywords"
    content="blog, development, programming, tech, go, golang, postgres, database, sql, benchmark, upsert, queries, cte, concurrency" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/" />


<title>
    
    Postgres: Benchmarking concurrently safe upsert queries :: Dev &amp; Chill  — A blog about coding
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" type="text/css" href="/main.045f18da88f8cb42336977558c8919c77ba0afb78827b7a1250d971d6cfd080e.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Postgres: Benchmarking concurrently safe upsert queries">
<meta itemprop="description" content="In my previous post I covered how to build concurrently safe upsert queries .
This post serves as a continuation where different approaches will be battle tested to expose the performance of each one:
Advisory lock On conflict update On conflict do nothing CTE queries Without further ado, let&rsquo;s start:
The application In order to emulate the scenario described on the previous post, an HTTP API is required. This one will connect to a database to perform the calls."><meta itemprop="datePublished" content="2020-05-13T16:40:29+01:00" />
<meta itemprop="dateModified" content="2020-05-13T16:40:29+01:00" />
<meta itemprop="wordCount" content="1574"><meta itemprop="image" content="https://devandchill.com/og-image.png"/>
<meta itemprop="keywords" content="go,golang,postgres,database,sql,benchmark,upsert,queries,cte,concurrency," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://devandchill.com/og-image.png"/>

<meta name="twitter:title" content="Postgres: Benchmarking concurrently safe upsert queries"/>
<meta name="twitter:description" content="In my previous post I covered how to build concurrently safe upsert queries .
This post serves as a continuation where different approaches will be battle tested to expose the performance of each one:
Advisory lock On conflict update On conflict do nothing CTE queries Without further ado, let&rsquo;s start:
The application In order to emulate the scenario described on the previous post, an HTTP API is required. This one will connect to a database to perform the calls."/>







<meta property="article:published_time" content="2020-05-13 16:40:29 &#43;0100 &#43;0100" />







<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138171880-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138171880-1');
</script>



    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <img src="/dev-n-chill-logo.svg" alt="Dev &amp; Chill" />
        
    </div>
</a>


        <span class="header__right">
            
            <nav class="menu">
    <ul class="menu__inner"><li><a href="/blog">The blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/posts">Posts</a></li>
    </ul>
</nav>

            <span class="menu-trigger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">

  <div class="post-info">
    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-clock">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      8 minutes

      
    </p>
  </div>

  <article>
    <h1 class="post-title">
      <a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/">Postgres: Benchmarking concurrently safe upsert queries</a>
    </h1>

    

    

    

    <div class="post-content">
      <p>In my previous post I covered how to <a href="https://devandchill.com/posts/2020/02/postgres-building-concurrently-safe-upsert-queries"  target="_blank" rel="noreferrer noopener" >build concurrently safe upsert queries</a>
.</p>
<p>This post serves as a continuation where different approaches will be battle tested to expose the performance of each one:</p>
<ul>
<li>Advisory lock</li>
<li>On conflict update</li>
<li>On conflict do nothing</li>
<li>CTE queries</li>
</ul>
<p>Without further ado, let&rsquo;s start:</p>
<h2 id="the-application">The application</h2>
<p>In order to emulate the scenario described on the previous post, an HTTP API is required. This one will connect to a database to perform the calls.
The application is written in Go and can be found <a href="https://github.com/pmorelli92/pg-upsert-returning"  target="_blank" rel="noreferrer noopener" >here</a>
.</p>
<p>The application is plain simple, as it contains few files:</p>
<ul>
<li><em>cmd/main.go</em>: Responsible for bootstrapping the postgres connection and http server.</li>
<li><em>server/server.go</em>: Exposes different endpoints, performs body parsing and error checking.</li>
<li><em>domain/domain.go</em>: Exposes the <code>UpsertedRow</code> struct that will be returned by postgres.</li>
<li><em>postgres/postgres.go</em>: Contains functions for each approach listed above, all with the same signature so they can be consumed easily on the server file. Yes, on an a real world app, do not inject database handlers directly on the transport layer.</li>
</ul>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>Since we are going to use postgres, an instance needs to be set up, and for convenience this example uses docker:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --name db -p 5432:5432 -e POSTGRES_HOST_AUTH_METHOD<span style="color:#81a1c1">=</span>trust postgres:latest
</span></span></code></pre></div><p>A file named <code>seed.psql</code> is also present on the root of the repository:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">CREATE</span> <span style="color:#81a1c1;font-weight:bold">DATABASE</span> customer_svc<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">CREATE</span> <span style="color:#81a1c1;font-weight:bold">TABLE</span> customers<span style="color:#eceff4">(</span>id <span style="color:#81a1c1">SERIAL</span><span style="color:#eceff4">,</span> customer_id UUID <span style="color:#81a1c1;font-weight:bold">NOT</span> <span style="color:#81a1c1;font-weight:bold">NULL</span> <span style="color:#81a1c1;font-weight:bold">PRIMARY</span> <span style="color:#81a1c1;font-weight:bold">KEY</span><span style="color:#eceff4">);</span>
</span></span></code></pre></div><h2 id="running-the-application">Running the application</h2>
<p>The application can be run in a container as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build -t pg-upsert-app:local .
</span></span><span style="display:flex;"><span>docker run -p 8080:8080 --link db --name app -i pg-upsert-app:local
</span></span></code></pre></div><h2 id="benchmarking">Benchmarking</h2>
<p>For the benchmark, the tool <a href="https://github.com/tsenart/vegeta"  target="_blank" rel="noreferrer noopener" >vegeta</a>
 is used. This tool allows doing HTTP load testing which will be used against the API.</p>
<p>The test suite is just a bash script that will feature a similar logic for each approach to be tested; example:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>UPSERT_LOCK<span style="color:#81a1c1">=</span><span style="color:#81a1c1;font-weight:bold">$(</span><span style="color:#81a1c1">echo</span> <span style="color:#a3be8c">&#39;{
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">  method: &#34;POST&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">  url: &#34;http://app:8080/upsert-lock&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">  body:&#34;{\&#34;id\&#34;: \&#34;&lt;ruuid&gt;\&#34;}&#34; | @base64,
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">  header: {&#34;Content-Type&#34;: [&#34;application/json&#34;]}
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">}&#39;</span> <span style="color:#eceff4">|</span> sed <span style="color:#a3be8c">&#34;s/&lt;ruuid&gt;/</span><span style="color:#81a1c1;font-weight:bold">$(</span>uuidgen <span style="color:#eceff4">|</span> tr <span style="color:#a3be8c">&#39;[:upper:]&#39;</span> <span style="color:#a3be8c">&#39;[:lower:]&#39;</span><span style="color:#81a1c1;font-weight:bold">)</span><span style="color:#a3be8c">/g&#34;</span><span style="color:#81a1c1;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">echo</span> <span style="color:#a3be8c">&#34;EXECUTING FOR LOCKS&#34;</span>
</span></span><span style="display:flex;"><span>jq -ncM <span style="color:#a3be8c">&#34;</span>$UPSERT_LOCK<span style="color:#a3be8c">&#34;</span> <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>  <span style="color:#eceff4">|</span> vegeta attack -format<span style="color:#81a1c1">=</span>json -duration<span style="color:#81a1c1">=</span>40s -connections<span style="color:#81a1c1">=</span><span style="color:#b48ead">20</span> -rate<span style="color:#81a1c1">=</span><span style="color:#b48ead">100</span> <span style="color:#eceff4">|</span> vegeta encode <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>  <span style="color:#eceff4">|</span> vegeta report -type<span style="color:#81a1c1">=</span><span style="color:#a3be8c">&#34;hist[0,2ms,4ms,6ms,8ms,10ms,15ms]&#34;</span>
</span></span></code></pre></div><p>This is translated to the following:</p>
<ul>
<li>Echo a <code>POST</code> request towards <code>http://app:8080/upsert-lock</code> with the payload <code>{&quot;id&quot;: &quot;some-uuid-generated-at-runtime&quot;}</code>. This uuid will be repeated for each call performed in the given scenario.</li>
<li>Parse this echoed string as a json, and use it as an input for vegeta tool.</li>
<li>Execute requests for 40 seconds with 20 concurrent connections at a rate of 100 request per second; in other words 4000 request distributed across 20 connections for 40 seconds.</li>
<li>The results will be aggregated into different buckets determined by <code>hist[0,2ms,4ms,6ms,8ms,10ms,15ms]</code>.</li>
</ul>
<p>The execution of this test is also dockerized so there is no need to download additional tools:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build -t benchmark:local -f benchmark/Dockerfile benchmark/.
</span></span><span style="display:flex;"><span>docker run --link app -t benchmark:local
</span></span></code></pre></div><p>In order to avoid results influenced by the warm up phase of the app, the test suite was executed twice and only the results from the last execution are shown below.</p>
<h2 id="advisory-lock">Advisory lock</h2>
<p>As the previous post indicates this approach is the less scalable. The introduction of a custom application lock in the database is not a good design model and the results are showing that:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EXECUTING FOR LOCKS
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">974</span>   24.35%  <span style="color:#616e87;font-style:italic">##################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2771</span>  69.27%  <span style="color:#616e87;font-style:italic">###################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">244</span>   6.10%   <span style="color:#616e87;font-style:italic">####</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">10</span>    0.25%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>Not only that but the code is also more complex than other solutions:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>repo <span style="color:#81a1c1">*</span>pgCustomerRepo<span style="color:#eceff4">)</span> <span style="color:#88c0d0">UpsertCustomerLock</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> id uuid<span style="color:#eceff4">.</span>UUID<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>res domain<span style="color:#eceff4">.</span>UpsertedRow<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">error</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	tx<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">BeginTx</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	_<span style="color:#eceff4">,</span> err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">ExecContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;SELECT pg_advisory_xact_lock($1)&#34;</span><span style="color:#eceff4">,</span> <span style="color:#88c0d0">hash</span><span style="color:#eceff4">(</span>id<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	r <span style="color:#81a1c1">:=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;SELECT ctid, xmax, id FROM customers WHERE customer_id = $1&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#eceff4">=</span> r<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#81a1c1">&amp;&amp;</span> err <span style="color:#81a1c1">==</span> sql<span style="color:#eceff4">.</span>ErrNoRows <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		q <span style="color:#81a1c1">:=</span> <span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id) VALUES($1) RETURNING ctid, xmax, id&#34;</span>
</span></span><span style="display:flex;"><span>		row <span style="color:#81a1c1">:=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> q<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">==</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Commit</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span> <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Rollback</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">hash</span><span style="color:#eceff4">(</span>s <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">int64</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	h <span style="color:#81a1c1">:=</span> fnv<span style="color:#eceff4">.</span><span style="color:#88c0d0">New64a</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>	h<span style="color:#eceff4">.</span><span style="color:#88c0d0">Write</span><span style="color:#eceff4">([]</span><span style="color:#81a1c1">byte</span><span style="color:#eceff4">(</span>s<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1">int64</span><span style="color:#eceff4">(</span>h<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sum64</span><span style="color:#eceff4">())</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><ol>
<li>Create the transaction.</li>
<li>Get a deterministic <code>int64</code> for the given uuid, and perform the lock (subsequent calls will have to wait here until the transaction ends)</li>
<li>Get the customer.</li>
<li>If customer does not exist, create it and return it back.</li>
<li>Commit the transaction.</li>
</ol>
<h2 id="upsert-on-conflict">Upsert on conflict</h2>
<p>This one is most likely the most common solution for these kind of cases. The results are better than the previous one but it is still not a good design.</p>
<p>Remember, updating on conflict will cause the following side effects:</p>
<ul>
<li>Old row is removed, a new is added.</li>
<li>It modifies the row transaction id, an &ldquo;old&rdquo; that got updated row will have a new transaction timestamp.</li>
<li>Firing triggers affecting the table.</li>
</ul>
<p>For a better refresher, click <a href="https://devandchill.com/posts/2020/02/postgres-building-concurrently-safe-upsert-queries/#4-on-conflict-update"  target="_blank" rel="noreferrer noopener" >here</a>
</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EXECUTING FOR UPSERT CONFLICT
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1777</span>  44.42%  <span style="color:#616e87;font-style:italic">#################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1938</span>  48.45%  <span style="color:#616e87;font-style:italic">####################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">158</span>   3.95%   <span style="color:#616e87;font-style:italic">##</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">72</span>    1.80%   <span style="color:#616e87;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">33</span>    0.83%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">18</span>    0.45%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">4</span>     0.10%
</span></span></code></pre></div><p>The code here is simpler, so this one feels easier:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>repo <span style="color:#81a1c1">*</span>pgCustomerRepo<span style="color:#eceff4">)</span> <span style="color:#88c0d0">UpsertCustomerConflict</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> id uuid<span style="color:#eceff4">.</span>UUID<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>res domain<span style="color:#eceff4">.</span>UpsertedRow<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">error</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	query <span style="color:#81a1c1">:=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id) VALUES($1) &#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;ON CONFLICT (customer_id) DO UPDATE SET customer_id = excluded.customer_id &#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;RETURNING ctid, xmax, id&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	row <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><ol>
<li>Insert the customer.</li>
<li>If customer exists, update (delete + create) the row overriding the id with the same id.</li>
<li>Get back the data.</li>
</ol>
<h2 id="upsert-do-nothing">Upsert do nothing</h2>
<p>The following approach has its pros and cons. The pros are that there are no side effects being caused in the database, and the application is not doing any kind of locking. This approach can be referred to write first, read later.</p>
<p>There are two ways to achieve this technique:</p>
<ul>
<li>Same batch, write then read, one roundtrip.</li>
<li>Two batches, first one: write, second one: read, two round trips.</li>
</ul>
<p>If two batches are going to be used, the performance will end up being somewhat like the locking scenario, since there is a need of going several times to the database.</p>
<p>The example displayed below shows how to achieve it in only one batch; but then again this is part of the cons. By nature Postgres does not allow sending two parameterized query statements on the same batch; so the parameters should be resolved before sending the query which can led to SQL injection.</p>
<p>The example below shows how to bypass Postgres limit avoiding parameters; but this is not a good practice, as it can introduce security vulnerabilities in case we are dealing with parameters like strings.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>repo <span style="color:#81a1c1">*</span>pgCustomerRepo<span style="color:#eceff4">)</span> <span style="color:#88c0d0">UpsertCustomerDoNothing</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> id uuid<span style="color:#eceff4">.</span>UUID<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>res domain<span style="color:#eceff4">.</span>UpsertedRow<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">error</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	query <span style="color:#81a1c1">:=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id)	VALUES($1) ON CONFLICT DO NOTHING;&#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;SELECT ctid, xmax, id FROM customers WHERE customer_id = $1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	query <span style="color:#eceff4">=</span> strings<span style="color:#eceff4">.</span><span style="color:#88c0d0">ReplaceAll</span><span style="color:#eceff4">(</span>query<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;$1&#34;</span><span style="color:#eceff4">,</span> fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;&#39;%s&#39;&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">()))</span>
</span></span><span style="display:flex;"><span>	row <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><ol>
<li>Insert the customer, if the customer exists, do nothing.</li>
<li>Fetch the customer.</li>
</ol>
<p>The performance if this is accomplished in one batch is good, but don&rsquo;t do it as security is more important than premature optimization:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EXECUTING FOR UPSERT DO NOTHING
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">3426</span>  85.65%  <span style="color:#616e87;font-style:italic">################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">572</span>   14.30%  <span style="color:#616e87;font-style:italic">##########</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><h2 id="cte-queries">CTE queries</h2>
<p>Last, this approach is not the most pleasant to read but it has some pros:</p>
<ul>
<li>No side effects on the database.</li>
<li>No custom application locking.</li>
<li>Parameterized queries.</li>
<li>Works with database engines that do not support <code>ON CONFLICT DO ...</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EXECUTING FOR UPSERT CTE
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2950</span>  73.75%  <span style="color:#616e87;font-style:italic">#######################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1034</span>  25.85%  <span style="color:#616e87;font-style:italic">###################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">14</span>    0.35%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2</span>     0.05%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>The code is displayed below:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>repo <span style="color:#81a1c1">*</span>pgCustomerRepo<span style="color:#eceff4">)</span> <span style="color:#88c0d0">UpsertCustomerCte</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> id uuid<span style="color:#eceff4">.</span>UUID<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>res domain<span style="color:#eceff4">.</span>UpsertedRow<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">error</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	query <span style="color:#81a1c1">:=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;WITH &#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a3be8c">&#34;search AS (SELECT ctid, xmax, id FROM customers WHERE customer_id = $1 LIMIT 1),&#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a3be8c">&#34;add AS (INSERT INTO customers (customer_id) SELECT $1 WHERE NOT EXISTS(SELECT id from search) RETURNING ctid, xmax, id)&#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;SELECT ctid, xmax, id from add	UNION ALL SELECT ctid, xmax, id from search&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	row <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><ol>
<li>Prepare the <code>search</code> statement.</li>
<li>Prepare the <code>add</code> statement that will only add a customer if <code>search</code> does not return one.</li>
<li>Execute both statements with a <code>union</code>, only one of the statements will return the customer.</li>
</ol>
<h2 id="recap">Recap</h2>
<p>In this post different approaches were battle tested; there is no holy grail or golden rule when it comes to database modelling.</p>
<p>The results showed here do not indicate that your project has to use CTE queries. Always the healthier approach is to ask yourself and the team:</p>
<ul>
<li>Do we have this problem?</li>
<li>Why do we have this problem?</li>
<li>Is there anything we can do to get rid of this problem?</li>
<li>Brainstorm session, avoid premature optimization, avoid over engineering.</li>
<li>Take a decision.</li>
</ul>
<p>Keeping this in mind, will probably avoid falling into design traps or solutions that were not needed in the first place.</p>
<p>As a last sentence, if you consider this is useful, do not hesitate on sharing this on your favorite social media. See you next time!</p>

    </div>
  </article>

  <hr />

  <div class="post-info">
    
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://devandchill.com/tags/go/">go</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/golang/">golang</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/postgres/">postgres</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/database/">database</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/sql/">sql</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/benchmark/">benchmark</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/upsert/">upsert</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/queries/">queries</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/cte/">cte</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/concurrency/">concurrency</a></span>
        
    </p>

    

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-file-text">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      1574 Words
    </p>

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-calendar">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      
      2020-05-13 17:40 &#43;0200
      

      
      
      
    </p>
  </div>

  
  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">Read other posts</span>
      <hr />
    </div>

    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://devandchill.com/posts/2020/05/go-lib/pq-or-pgx-which-performs-better/">
          <span class="button__icon">←</span>
          <span class="button__text">Go - lib/pq or pgx - which performs better?</span>
        </a>
      </span>
      

      
      <span class="button next">
        <a href="https://devandchill.com/posts/2020/02/postgres-building-concurrently-safe-upsert-queries/">
          <span class="button__text">Postgres: Building concurrently safe upsert queries</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  
  

  
  

</main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        


<script type="text/javascript" src="/bundle.min.69fb501ac7bace7c0ca982d98573883fe084cb258084917289a51bc0bc04868a1b91b95a34c641d2854f64b4b0245430430f86fa70e19f7425062100c9b69215.js" integrity="sha512-aftQGse6znwMqYLZhXOIP&#43;CEyyWAhJFyiaUbwLwEhoobkblaNMZB0oVPZLSwJFQwQw&#43;G&#43;nDhn3QlBiEAybaSFQ=="></script>



    </body>
</html>
