<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Some days ago a coworker of mine linked me to the source code of Google&rsquo;s exposure notifications API and of course is a good chance to see how Google is doing Go related codebases.
Continuing with the topic of Postgres and benchmarking, I decided to check out how Postgres configuration was done and this line got my attention:
import ( ... &#34;github.com/jackc/pgx/v4/pgxpool&#34; ) What is pgx, and why should we care? Pgx is a library that implements postgres connection without relying on the database/sql standard package. The source code can be found here ; and as the readme states:
" />
<meta name="keywords" content="blog, development, programming, tech, golang, go, postgres, database, sql, benchmark, libpq, pgx, batch, cache" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://devandchill.com/posts/2020/05/go-lib/pq-or-pgx-which-performs-better/" />


    <title>
        
            Go - lib/pq or pgx - which performs better? :: Dev &amp; Chill  — A blog about coding
        
    </title>





  <link rel="stylesheet" href="/main.min.0f16d1047324afb51169baa1beb2326e7ed80d766cc5d1cf37704120766aa598.css" integrity="sha256-DxbRBHMkr7URabqhvrIybn7YDXZsxdHPN3BBIHZqpZg=" crossorigin="anonymous">





    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">



  <meta itemprop="name" content="Go - lib/pq or pgx - which performs better?">
  <meta itemprop="description" content="Some days ago a coworker of mine linked me to the source code of Google’s exposure notifications API and of course is a good chance to see how Google is doing Go related codebases.
Continuing with the topic of Postgres and benchmarking, I decided to check out how Postgres configuration was done and this line got my attention:
import ( ... &#34;github.com/jackc/pgx/v4/pgxpool&#34; ) What is pgx, and why should we care? Pgx is a library that implements postgres connection without relying on the database/sql standard package. The source code can be found here ; and as the readme states:">
  <meta itemprop="datePublished" content="2020-05-27T15:40:29+01:00">
  <meta itemprop="dateModified" content="2020-05-27T15:40:29+01:00">
  <meta itemprop="wordCount" content="1917">
  <meta itemprop="image" content="https://devandchill.com/og-image.png">
  <meta itemprop="keywords" content="Golang,Go,Postgres,Database,Sql,Benchmark,Libpq,Pgx,Batch,Cache">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://devandchill.com/og-image.png">
  <meta name="twitter:title" content="Go - lib/pq or pgx - which performs better?">
  <meta name="twitter:description" content="Some days ago a coworker of mine linked me to the source code of Google’s exposure notifications API and of course is a good chance to see how Google is doing Go related codebases.
Continuing with the topic of Postgres and benchmarking, I decided to check out how Postgres configuration was done and this line got my attention:
import ( ... &#34;github.com/jackc/pgx/v4/pgxpool&#34; ) What is pgx, and why should we care? Pgx is a library that implements postgres connection without relying on the database/sql standard package. The source code can be found here ; and as the readme states:">







    <meta property="article:published_time" content="2020-05-27 15:40:29 &#43;0100 &#43;0100" />







    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7X0TBDP4QB"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7X0TBDP4QB');
        }
      </script>



    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <img src="/dev-n-chill-logo.svg" alt="Dev &amp; Chill" />
        
    </div>
</a>


        <span class="header__right">
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/posts">Posts</a></li><li><a href="/resume">Resume</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        9 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://devandchill.com/posts/2020/05/go-lib/pq-or-pgx-which-performs-better/">Go - lib/pq or pgx - which performs better?</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>Some days ago a coworker of mine linked me to the source code of <a href="https://github.com/google/exposure-notifications-server"  target="_blank" rel="noreferrer noopener" >Google&rsquo;s exposure notifications API</a>
 and of course is a good chance to see how Google is doing Go related codebases.</p>
<p>Continuing with the topic of Postgres and benchmarking, I decided to check out how Postgres configuration was done and this <a href="https://github.com/google/exposure-notifications-server/blob/master/internal/database/connection.go#L27"  target="_blank" rel="noreferrer noopener" >line</a>
 got my attention:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">import</span> <span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;github.com/jackc/pgx/v4/pgxpool&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">)</span>
</span></span></code></pre></div><h2 id="what-is-pgx-and-why-should-we-care">What is pgx, and why should we care?</h2>
<p><code>Pgx</code> is a library that implements postgres connection without relying on the <code>database/sql</code> standard package. The source code can be found <a href="https://github.com/jackc/pgx"  target="_blank" rel="noreferrer noopener" >here</a>
; and as the readme states:</p>
<blockquote>
<p>pgx aims to be low-level, fast, and performant, while also enabling PostgreSQL-specific features that the standard database/sql package does not allow for.</p></blockquote>
<blockquote>
<p>pgx supports many features beyond what is available through database/sql:</p>
<ul>
<li>[&hellip;]</li>
<li>Automatic statement preparation and caching</li>
<li>Batch queries</li>
<li>Single-round trip query mode</li>
<li>Connection pool with after-connect hook for arbitrary connection setup</li>
</ul></blockquote>
<blockquote>
<p>Automatic statement preparation and caching - pgx will prepare and cache statements by default. This can provide an significant free improvement to code that does not explicitly use prepared statements. Under certain workloads, it can perform nearly 3x the number of queries per second.</p></blockquote>
<blockquote>
<p>Batched queries - Multiple queries can be batched together to minimize network round trips.</p></blockquote>
<p>And these are just a bunch of things picked from the readme, but there are some strong statements which are analyzed below to see if they are true or not.</p>
<h2 id="benchmarking">Benchmarking</h2>
<p>On my previous post <a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/"  target="_blank" rel="noreferrer noopener" >Benchmarking concurrently safe upsert queries</a>
 I showed an application using <code>lib/pq</code> and benchmark for different queries, all trying to solve the same scenario. In order not to make the post larger than necessary, please check the details on the link above.</p>
<p>In this post, the application shown before will be used and we will cover:</p>
<ul>
<li>How to migrate from lib/pq to pgx.</li>
<li>Compare the benchmark between both.</li>
</ul>
<p>Without further ado, let&rsquo;s begin.</p>
<h2 id="connection-handling">Connection handling</h2>
<p>On the <code>lib/pq</code> version, <code>database/sql</code> is being used to create a struct holding a <code>*sql.Db</code> variable which was being used for every call to the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">type</span> pgCustomerRepo <span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	dbHandler <span style="color:#81a1c1">*</span>sql<span style="color:#eceff4">.</span>DB
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">NewPgCustomerRepo</span><span style="color:#eceff4">(</span>connString <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">*</span>pgCustomerRepo<span style="color:#eceff4">,</span> <span style="color:#81a1c1">error</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	db<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> sql<span style="color:#eceff4">.</span><span style="color:#88c0d0">Open</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;postgres&#34;</span><span style="color:#eceff4">,</span> connString<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">,</span> err
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1">&amp;</span>pgCustomerRepo<span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		dbHandler<span style="color:#eceff4">:</span> db<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">},</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Using <code>pgx</code> this is changed to:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">type</span> pgCustomerRepo <span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	dbHandler <span style="color:#81a1c1">*</span>pgxpool<span style="color:#eceff4">.</span>Pool
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">NewPgCustomerRepo</span><span style="color:#eceff4">(</span>connString <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">*</span>pgCustomerRepo<span style="color:#eceff4">,</span> <span style="color:#81a1c1">error</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	config<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> pgxpool<span style="color:#eceff4">.</span><span style="color:#88c0d0">ParseConfig</span><span style="color:#eceff4">(</span>connString<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">,</span> err
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	config<span style="color:#eceff4">.</span>AfterConnect <span style="color:#eceff4">=</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> conn <span style="color:#81a1c1">*</span>pgx<span style="color:#eceff4">.</span>Conn<span style="color:#eceff4">)</span> <span style="color:#81a1c1">error</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		conn<span style="color:#eceff4">.</span><span style="color:#88c0d0">ConnInfo</span><span style="color:#eceff4">().</span><span style="color:#88c0d0">RegisterDataType</span><span style="color:#eceff4">(</span>pgtype<span style="color:#eceff4">.</span>DataType<span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			Value<span style="color:#eceff4">:</span> <span style="color:#81a1c1">&amp;</span>MyTid<span style="color:#eceff4">{</span><span style="color:#81a1c1">&amp;</span>pgtype<span style="color:#eceff4">.</span>TID<span style="color:#eceff4">{}},</span>
</span></span><span style="display:flex;"><span>			Name<span style="color:#eceff4">:</span>  <span style="color:#a3be8c">&#34;tid&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>			OID<span style="color:#eceff4">:</span>   pgtype<span style="color:#eceff4">.</span>TIDOID<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	db<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> pgxpool<span style="color:#eceff4">.</span><span style="color:#88c0d0">ConnectConfig</span><span style="color:#eceff4">(</span>context<span style="color:#eceff4">.</span><span style="color:#88c0d0">Background</span><span style="color:#eceff4">(),</span> config<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">,</span> err
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1">&amp;</span>pgCustomerRepo<span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		dbHandler<span style="color:#eceff4">:</span> db<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">},</span> <span style="color:#81a1c1;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Since the idea is to try out the pooling mechanism, a pool configuration is created and used for the connection. This is fairly simple, but there is more than just that in the code.</p>
<p>The function <code>AfterConnect</code> allows the developer to hook custom behaviors into the database connection. As for this example a custom mapping is added to map a <code>TID</code> field to a string. <code>TID</code> is the Postgres type we get when we query <code>SELECT ctid</code>.</p>
<p>It is understandable that a real world application will not fetch this type of data thus the mapping was not implemented. For this <a href="https://github.com/jackc/pgtype/pull/29"  target="_blank" rel="noreferrer noopener" >I&rsquo;ve submitted a PR</a>
 but it did not reach a release tag at the moment I am writing this; so I added the custom hook in the code.</p>
<p>Again, in a real world application it is likely that an <code>AfterConnect</code> hook is not needed, but it is valuable knowing that you can use it if you need it.</p>
<p>With the connection covered, let&rsquo;s move to the queries:</p>
<h3 id="advisory-lock">Advisory Lock</h3>
<p>The changes to the code are barely there. All of the <code>pgx</code> functions that go against the database expect a <code>context</code> and there is none non-context alternative.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>tx<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">BeginTx</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>tx<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">BeginTx</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> pgx<span style="color:#eceff4">.</span>TxOptions<span style="color:#eceff4">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_<span style="color:#eceff4">,</span> err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">ExecContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;SELECT pg_advisory_xact_lock($1)&#34;</span><span style="color:#eceff4">,</span> <span style="color:#88c0d0">hash</span><span style="color:#eceff4">(</span>id<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">()))</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>_<span style="color:#eceff4">,</span> err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exec</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;SELECT pg_advisory_xact_lock($1)&#34;</span><span style="color:#eceff4">,</span> <span style="color:#88c0d0">hash</span><span style="color:#eceff4">(</span>id<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">()))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#81a1c1">:=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;SELECT ctid, xmax, id FROM customers WHERE customer_id = $1&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> r<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRow</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;SELECT ctid, xmax, id FROM customers WHERE customer_id = $1&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">).</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>q <span style="color:#81a1c1">:=</span> <span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id) VALUES($1) RETURNING ctid, xmax, id&#34;</span>
</span></span><span style="display:flex;"><span>row <span style="color:#81a1c1">:=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> q<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>q <span style="color:#81a1c1">:=</span> <span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id) VALUES($1) RETURNING ctid, xmax, id&#34;</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRow</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> q<span style="color:#eceff4">,</span> id<span style="color:#eceff4">).</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Commit</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Commit</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Rollback</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> tx<span style="color:#eceff4">.</span><span style="color:#88c0d0">Rollback</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>As for the performance:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LIB/PQ: EXECUTING FOR LOCKS
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">974</span>   24.35%  <span style="color:#616e87;font-style:italic">##################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2771</span>  69.27%  <span style="color:#616e87;font-style:italic">###################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">244</span>   6.10%   <span style="color:#616e87;font-style:italic">####</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">10</span>    0.25%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PGX: EXECUTING FOR LOCKS
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2442</span>  61.05%  <span style="color:#616e87;font-style:italic">#############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1506</span>  37.65%  <span style="color:#616e87;font-style:italic">############################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">38</span>    0.95%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">11</span>    0.27%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">2</span>     0.05%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>And this is awesome! Out of the box without changing too much the code, the result is already speaking for itself.</p>
<h2 id="upsert-on-conflict">Upsert on conflict</h2>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>query <span style="color:#81a1c1">:=</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id) VALUES($1) &#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;ON CONFLICT (customer_id) DO UPDATE SET customer_id = excluded.customer_id RETURNING ctid, xmax, id&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>row <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRow</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">,</span> id<span style="color:#eceff4">).</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>Even simpler than the previous one, now there is a one liner.</p>
<p>Benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LIB/PQ: EXECUTING FOR UPSERT CONFLICT
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1777</span>  44.42%  <span style="color:#616e87;font-style:italic">#################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1938</span>  48.45%  <span style="color:#616e87;font-style:italic">####################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">158</span>   3.95%   <span style="color:#616e87;font-style:italic">##</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">72</span>    1.80%   <span style="color:#616e87;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">33</span>    0.83%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">18</span>    0.45%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">4</span>     0.10%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PGX: EXECUTING FOR UPSERT CONFLICT
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2676</span>  66.90%  <span style="color:#616e87;font-style:italic">##################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1295</span>  32.38%  <span style="color:#616e87;font-style:italic">########################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">21</span>    0.53%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">6</span>     0.15%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>Yes, I am running the benchmark on the same computer, doing a warm up phase in which the results are discarded to be fair with the old benchmarks as well.</p>
<h2 id="upsert-do-nothing">Upsert do nothing</h2>
<p>As you can recall (if you read my previous post), there is a limitation when sending on the same <code>QueryContext</code> more than one parameterized query.</p>
<p>On the previous post, this was bypassed by a non good practice that was not sending parameterized queries but injecting the string; which as I stated previously it is a bad practice that can led to security vulnerabilities.</p>
<p>But on <code>pgx</code> there is a built-in support for sending a query batch in a single trip. And this definitely draw my attention since I find this approach the easiest to understand a.k.a <code>write first, read later</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>query <span style="color:#81a1c1">:=</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id)	VALUES($1) ON CONFLICT DO NOTHING;&#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;SELECT ctid, xmax, id FROM customers WHERE customer_id = $1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query <span style="color:#eceff4">=</span> strings<span style="color:#eceff4">.</span><span style="color:#88c0d0">ReplaceAll</span><span style="color:#eceff4">(</span>query<span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;$1&#34;</span><span style="color:#eceff4">,</span> fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;&#39;%s&#39;&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">.</span><span style="color:#88c0d0">String</span><span style="color:#eceff4">()))</span>
</span></span><span style="display:flex;"><span>row <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>This unsafe piece of code now can be converted to an elegant and performant way:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>batch <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1">&amp;</span>pgx<span style="color:#eceff4">.</span>Batch<span style="color:#eceff4">{}</span>
</span></span><span style="display:flex;"><span>batch<span style="color:#eceff4">.</span><span style="color:#88c0d0">Queue</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;INSERT INTO customers(customer_id) VALUES($1) ON CONFLICT DO NOTHING&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>batch<span style="color:#eceff4">.</span><span style="color:#88c0d0">Queue</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;SELECT ctid, xmax, id FROM customers WHERE customer_id = $1&#34;</span><span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>results <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">SendBatch</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> batch<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_<span style="color:#eceff4">,</span> err <span style="color:#eceff4">=</span> results<span style="color:#eceff4">.</span><span style="color:#88c0d0">Exec</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> results<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRow</span><span style="color:#eceff4">().</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> results<span style="color:#eceff4">.</span><span style="color:#88c0d0">Close</span><span style="color:#eceff4">()</span>
</span></span></code></pre></div><p>But does this truly work?</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LIB/PQ: EXECUTING FOR UPSERT DO NOTHING
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">3426</span>  85.65%  <span style="color:#616e87;font-style:italic">################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">572</span>   14.30%  <span style="color:#616e87;font-style:italic">##########</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PGX: EXECUTING FOR UPSERT DO NOTHING
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">3878</span>  96.95%  <span style="color:#616e87;font-style:italic">########################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">118</span>   2.95%   <span style="color:#616e87;font-style:italic">##</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">4</span>     0.10%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>And the answer is yes, it does work. Not only it is faster, but it managed to get rid of the vulnerability issue and allows the code to send two parameterized queries in one round trip.</p>
<p>Now if someone asks me if I choose doing this over CTE queries for this scenario, I will lean more on this approach since it is easier to comprehend.</p>
<h2 id="cte-queries">CTE queries</h2>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>query <span style="color:#81a1c1">:=</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;WITH &#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;search AS (SELECT ctid, xmax, id FROM customers WHERE customer_id = $1 LIMIT 1),&#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;add AS (INSERT INTO customers (customer_id) SELECT $1 WHERE NOT EXISTS(SELECT id from search) RETURNING ctid, xmax, id)&#34;</span> <span style="color:#81a1c1">+</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a3be8c">&#34;SELECT ctid, xmax, id from add	UNION ALL SELECT ctid, xmax, id from search&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>row <span style="color:#81a1c1">:=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRowContext</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> row<span style="color:#eceff4">.</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">--</span><span style="color:#eceff4">&gt;</span>
</span></span><span style="display:flex;"><span>err <span style="color:#eceff4">=</span> repo<span style="color:#eceff4">.</span>dbHandler<span style="color:#eceff4">.</span><span style="color:#88c0d0">QueryRow</span><span style="color:#eceff4">(</span>ctx<span style="color:#eceff4">,</span> query<span style="color:#eceff4">,</span> id<span style="color:#eceff4">).</span><span style="color:#88c0d0">Scan</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>CTID<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>XMAX<span style="color:#eceff4">,</span> <span style="color:#81a1c1">&amp;</span>res<span style="color:#eceff4">.</span>ID<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>As with the other approaches, not much to change here.</p>
<p>Benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LIB/PQ: EXECUTING FOR UPSERT CTE
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2950</span>  73.75%  <span style="color:#616e87;font-style:italic">#######################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1034</span>  25.85%  <span style="color:#616e87;font-style:italic">###################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">14</span>    0.35%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2</span>     0.05%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PGX: EXECUTING FOR UPSERT CTE
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">3893</span>  97.32%  <span style="color:#616e87;font-style:italic">########################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">106</span>   2.65%   <span style="color:#616e87;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>And again, the results are impressive, but one can say now:</p>
<blockquote>
<p>In all of these approaches shown, the use case was to bombard the database in order to insert and fetch a customer with the same ID. Maybe the cache stops working when the parameter changes.</p></blockquote>
<p>Let&rsquo;s try it out:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>routes<span style="color:#eceff4">.</span><span style="color:#88c0d0">HandleFunc</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;/upsert-cte-random&#34;</span><span style="color:#eceff4">,</span> s<span style="color:#eceff4">.</span><span style="color:#88c0d0">UpsertCustomerRandom</span><span style="color:#eceff4">(</span>s<span style="color:#eceff4">.</span>CustomerRepo<span style="color:#eceff4">.</span>UpsertCustomerCte<span style="color:#eceff4">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>s <span style="color:#81a1c1">*</span>Server<span style="color:#eceff4">)</span> <span style="color:#88c0d0">UpsertCustomerRandom</span><span style="color:#eceff4">(</span>repoUpsert <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">(</span>ctx context<span style="color:#eceff4">.</span>Context<span style="color:#eceff4">,</span> id uuid<span style="color:#eceff4">.</span>UUID<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>res domain<span style="color:#eceff4">.</span>UpsertedRow<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">error</span><span style="color:#eceff4">))</span> http<span style="color:#eceff4">.</span>HandlerFunc <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">(</span>w http<span style="color:#eceff4">.</span>ResponseWriter<span style="color:#eceff4">,</span> r <span style="color:#81a1c1">*</span>http<span style="color:#eceff4">.</span>Request<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Call the repo generating a random UUID for each time</span>
</span></span><span style="display:flex;"><span>		start <span style="color:#81a1c1">:=</span> time<span style="color:#eceff4">.</span><span style="color:#88c0d0">Now</span><span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>		upserted<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> <span style="color:#88c0d0">repoUpsert</span><span style="color:#eceff4">(</span>r<span style="color:#eceff4">.</span><span style="color:#88c0d0">Context</span><span style="color:#eceff4">(),</span> uuid<span style="color:#eceff4">.</span><span style="color:#88c0d0">New</span><span style="color:#eceff4">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusInternalServerError<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span>err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Of course, in order to do a comparison, this new route was benchmarked using both <code>lib/pq</code> and <code>pgx</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LIB/PQ: EXECUTING FOR UPSERT CTE RANDOM
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1744</span>  43.60%  <span style="color:#616e87;font-style:italic">################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2208</span>  55.20%  <span style="color:#616e87;font-style:italic">#########################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">45</span>    1.12%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2</span>     0.05%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PGX: EXECUTING FOR UPSERT CTE RANDOM
</span></span><span style="display:flex;"><span>Bucket         <span style="color:#616e87;font-style:italic">#     %       Histogram</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>0s,    2ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">2643</span>  66.07%  <span style="color:#616e87;font-style:italic">#################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>2ms,   4ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1356</span>  33.90%  <span style="color:#616e87;font-style:italic">#########################</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>4ms,   6ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">1</span>     0.03%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>6ms,   8ms<span style="color:#81a1c1">]</span>   <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>8ms,   10ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>10ms,  15ms<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>15ms,  +Inf<span style="color:#81a1c1">]</span>  <span style="color:#b48ead">0</span>     0.00%
</span></span></code></pre></div><p>And as we can see, the cache is still doing its job.</p>
<h2 id="summary">Summary</h2>
<p>I discovered this library due to some luck but so far I have not been disappointed. I am not seeing a reason on not picking this library as default for standard CRUD applications. Of course, there might be use cases where it is not possible and then <code>lib/pq</code> can still do the job.</p>
<h2 id="some-additional-notes">Some additional notes</h2>
<ul>
<li>I am not being sponsored nor paid by the author of the library.</li>
<li>The code used for benchmarking can be found <a href="https://github.com/pmorelli92/pg-upsert-returning"  target="_blank" rel="noreferrer noopener" >here</a>
. The <code>master</code> branch contains the <code>lib/pq</code> code and the branch <code>refactor/pgx</code> contains the <code>pgx</code> code.</li>
<li>All the benchmarks can be executed easily by:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make run-db <span style="color:#81a1c1">(</span>create database and table after executing this<span style="color:#81a1c1">)</span>
</span></span><span style="display:flex;"><span>make run-app
</span></span><span style="display:flex;"><span>make run-bench
</span></span></code></pre></div><p>Last, but not least, if you consider this is useful, do not hesitate on sharing it on your favorite social media; and if there is a particular topic you want me to cover, just put it on the comments below.</p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://devandchill.com/tags/golang/">golang</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/go/">go</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/postgres/">postgres</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/database/">database</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/sql/">sql</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/benchmark/">benchmark</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/libpq/">libpq</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/pgx/">pgx</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/batch/">batch</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/cache/">cache</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        1917 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2020-05-27 16:40 &#43;0200
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        
        <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
        </div>
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://devandchill.com/posts/2020/08/stop-storing-secrets-on-environment-variables-enter-gcp-secret-manager/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Stop storing secrets on environment variables: Enter GCP Secret Manager</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/">
                    <span class="button__text">Postgres: Benchmarking concurrently safe upsert queries</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        


<script type="text/javascript" src="/bundle.min.2c9c676130329bfc6d81ffbc7aa868a0297c372efaa0480153e69a8c4fc512933e60b51061bd4b7108b4ce279a4a88037a7039e4129ea4c5744d10a320294886.js" integrity="sha512-LJxnYTAym/xtgf&#43;8eqhooCl8Ny76oEgBU&#43;aajE/FEpM&#43;YLUQYb1LcQi0zieaSogDenA55BKepMV0TRCjIClIhg=="></script>




    </body>
</html>
