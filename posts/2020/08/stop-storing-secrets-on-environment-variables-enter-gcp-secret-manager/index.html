<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="The other day I encountered the following post where Seth Vargo was doing some statements regarding the usage of environment variables:
[&hellip;] While this approach is simple and straightforward, it comes with considerable security drawbacks - the secrets exist in plaintext in the environment. Any other process, library, or dependency running inside the process has access to the environment which has already been exploited multiple times. Unfortunately, it is trivial for a malicious library author to inject this type of vulnerability into an otherwise helpful utility package. To be absolutely, unequivocally clear, you should not store secret or sensitive information in environment variables in plaintext.
" />
<meta name="keywords" content="blog, development, programming, tech, secrets, environment, env, variable, gcp, manager, secret manager, kubernetes, gcloud, iam, gke" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://devandchill.com/posts/2020/08/stop-storing-secrets-on-environment-variables-enter-gcp-secret-manager/" />


    <title>
        
            Stop storing secrets on environment variables: Enter GCP Secret Manager :: Dev &amp; Chill  — A blog about coding
        
    </title>





  <link rel="stylesheet" href="/main.min.0f16d1047324afb51169baa1beb2326e7ed80d766cc5d1cf37704120766aa598.css" integrity="sha256-DxbRBHMkr7URabqhvrIybn7YDXZsxdHPN3BBIHZqpZg=" crossorigin="anonymous">





    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">



  <meta itemprop="name" content="Stop storing secrets on environment variables: Enter GCP Secret Manager">
  <meta itemprop="description" content="The other day I encountered the following post where Seth Vargo was doing some statements regarding the usage of environment variables:
[…] While this approach is simple and straightforward, it comes with considerable security drawbacks - the secrets exist in plaintext in the environment. Any other process, library, or dependency running inside the process has access to the environment which has already been exploited multiple times. Unfortunately, it is trivial for a malicious library author to inject this type of vulnerability into an otherwise helpful utility package. To be absolutely, unequivocally clear, you should not store secret or sensitive information in environment variables in plaintext.">
  <meta itemprop="datePublished" content="2020-08-31T20:00:00+01:00">
  <meta itemprop="dateModified" content="2020-08-31T20:00:00+01:00">
  <meta itemprop="wordCount" content="2008">
  <meta itemprop="image" content="https://devandchill.com/og-image.png">
  <meta itemprop="keywords" content="Secrets,Environment,Env,Variable,Gcp,Manager,Secret Manager,Kubernetes,Gcloud,Iam,Gke">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://devandchill.com/og-image.png">
  <meta name="twitter:title" content="Stop storing secrets on environment variables: Enter GCP Secret Manager">
  <meta name="twitter:description" content="The other day I encountered the following post where Seth Vargo was doing some statements regarding the usage of environment variables:
[…] While this approach is simple and straightforward, it comes with considerable security drawbacks - the secrets exist in plaintext in the environment. Any other process, library, or dependency running inside the process has access to the environment which has already been exploited multiple times. Unfortunately, it is trivial for a malicious library author to inject this type of vulnerability into an otherwise helpful utility package. To be absolutely, unequivocally clear, you should not store secret or sensitive information in environment variables in plaintext.">







    <meta property="article:published_time" content="2020-08-31 20:00:00 &#43;0100 &#43;0100" />







    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7X0TBDP4QB"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7X0TBDP4QB');
        }
      </script>



    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <img src="/dev-n-chill-logo.svg" alt="Dev &amp; Chill" />
        
    </div>
</a>


        <span class="header__right">
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/posts">Posts</a></li><li><a href="/resume">Resume</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        10 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://devandchill.com/posts/2020/08/stop-storing-secrets-on-environment-variables-enter-gcp-secret-manager/">Stop storing secrets on environment variables: Enter GCP Secret Manager</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>The other day I encountered the <a href="https://www.sethvargo.com/secrets-in-serverless/"  target="_blank" rel="noreferrer noopener" >following post</a>
 where Seth Vargo was doing some statements regarding the usage of environment variables:</p>
<blockquote>
<p>[&hellip;] While this approach is simple and straightforward, it comes with considerable security drawbacks - the secrets exist in plaintext in the environment. Any other process, library, or dependency running inside the process has access to the environment which has already been exploited multiple times.
Unfortunately, it is trivial for a malicious library author to inject this type of vulnerability into an otherwise helpful utility package.
To be absolutely, unequivocally clear, you should not store secret or sensitive information in environment variables in plaintext.</p></blockquote>
<p>Then, the author, states some alternatives like using KMS to cypher values for the environment variables; using <a href="https://github.com/GoogleCloudPlatform/berglas"  target="_blank" rel="noreferrer noopener" >Berglas library</a>
 and also suggesting Hashicorp Vault.</p>
<p>At the time of that post, GCP was not offering a direct rival to Hashicorp Vault but a few months ago <a href="https://cloud.google.com/blog/products/identity-security/improving-your-security-posture-with-centralized-secrets-management"  target="_blank" rel="noreferrer noopener" >Google announced Secret Manager being GA</a>
.</p>
<p>As of now, at my current workplace we are migrating from a private cloud to GCP and I think there is not a better moment for me to analyze what are the benefits of using Secret Manager and how easy or hard is to make it work.</p>
<h3 id="deploying-resources">Deploying resources</h3>
<p>As some other companies, our workloads are deployed in a Kubernetes cluster (GKE on Google Cloud) while always trying to follow the Principle of Least Access in order to guarantee that a workload can only access to the resources it needs and cannot elevate privileges or modify some other resources.</p>
<p>It only seems fair to do a proof of concept that follows these guidelines:</p>
<ul>
<li>Create a service account with just the IAM (permissions on GCP) needed.</li>
<li>Deploy a GKE cluster using mentioned service account.</li>
<li>Deploy a pod inside that cluster and make sure it can access Secret Manager.</li>
</ul>
<p><strong>Let&rsquo;s start.</strong></p>
<p>Make sure the correct project is selected:</p>
<blockquote>
<p>From now on, replace pablo-test-project with your GCP project identifier when executing the commands.</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud config <span style="color:#81a1c1">set</span> project pablo-test-project
</span></span></code></pre></div><p>For accessing Secret Manager API from our Google Kubernetes Engine there are three things that needs to be done.</p>
<h4 id="enable-secret-manager-api">Enable Secret Manager API</h4>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud services <span style="color:#81a1c1">enable</span> secretmanager.googleapis.com
</span></span></code></pre></div><p><a href="https://console.cloud.google.com/apis/library/secretmanager.googleapis.com"  target="_blank" rel="noreferrer noopener" >Or from the Console UI.</a>
</p>
<h4 id="set-corresponding-iam-role-on-the-service-account-running-the-instance">Set corresponding IAM role on the service account running the instance</h4>
<p><a href="https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions"  target="_blank" rel="noreferrer noopener" >From service account documentation.</a>
</p>
<blockquote>
<p>When you set up an instance to run as a service account, you determine the level of access the service account has by the IAM roles that you grant to the service account. If the service account has no IAM roles, then no API methods can be run by the service account on that instance.
Furthermore, an instance&rsquo;s access scopes determine the default OAuth scopes for requests made through the gcloud tool and client libraries on the instance. As a result, access scopes potentially further limit access to API methods when authenticating through OAuth. [&hellip;]</p></blockquote>
<p>In order to assign the corresponding IAM roles to the service account, the account should be created first:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud iam service-accounts create demo-service-account <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--description<span style="color:#81a1c1">=</span><span style="color:#a3be8c">&#39;Service account used for our demo cluster&#39;</span> <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--display-name<span style="color:#81a1c1">=</span>demo-service-account
</span></span></code></pre></div><p>The role to be assigned to this service account is <a href="https://cloud.google.com/iam/docs/understanding-roles#secret-manager-roles"  target="_blank" rel="noreferrer noopener" >roles/secretmanager.secretAccessor</a>
 which allows accessing the payload of secrets:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud projects add-iam-policy-binding pablo-test-project <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--member<span style="color:#81a1c1">=</span>serviceAccount:demo-service-account@pablo-test-project.iam.gserviceaccount.com <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--role<span style="color:#81a1c1">=</span>roles/secretmanager.secretAccessor
</span></span></code></pre></div><h4 id="configure-oauth-scopes-on-the-instance-that-consumes-the-api">Configure OAuth scopes on the instance that consumes the API</h4>
<p><a href="https://cloud.google.com/secret-manager/docs/access-control"  target="_blank" rel="noreferrer noopener" >From access control documentation.</a>
</p>
<blockquote>
<p>To access the Secret Manager API from within a Compute Engine instance or a Google Kubernetes Engine node (which is also a Compute Engine instance), the instance must have the cloud-platform OAuth scope. For more information about access scopes in Compute Engine, see Service account permissions in the Compute Engine documentation.</p></blockquote>
<p>As mentioned before, an instance&rsquo;s access scopes determine the default OAuth2 scopes for requests made. So the Kubernetes instance that is going to be created needs the <code>cloud-platform</code> scope. And also don&rsquo;t forget to indicate the service account created before.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud container clusters create demo-cluster <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--zone<span style="color:#81a1c1">=</span>europe-west3-a <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--num-nodes<span style="color:#81a1c1">=</span><span style="color:#b48ead">1</span> <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--machine-type<span style="color:#81a1c1">=</span>n1-standard-1 <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--service-account<span style="color:#81a1c1">=</span>demo-service-account@pablo-test-project.iam.gserviceaccount.com <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--scopes<span style="color:#81a1c1">=</span>https://www.googleapis.com/auth/monitoring,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/cloud-platform
</span></span></code></pre></div><p>After the cluster is deployed, get the credentials for <code>kubectl</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud container clusters get-credentials demo-cluster --zone europe-west3-a
</span></span></code></pre></div><p>Before proceeding further with the cluster, create a secret and add a value on the Secret Manager:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud secrets create MY_SECRET
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">printf</span> <span style="color:#a3be8c">&#34;s3cr3t&#34;</span> <span style="color:#eceff4">|</span> gcloud secrets versions add MY_SECRET --data-file<span style="color:#81a1c1">=</span>-
</span></span></code></pre></div><p>To test that the instance can access to Secret Manager API, a dummy pod will be deployed so that you can exec into it:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>cat &lt;&lt;EOF | kubectl apply -f -
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">apiVersion</span><span style="color:#eceff4">:</span> v1
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">kind</span><span style="color:#eceff4">:</span> Pod
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">metadata</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> httpbin
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">spec</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">containers</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#81a1c1">image</span><span style="color:#eceff4">:</span> docker.io/kennethreitz/httpbin
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">imagePullPolicy</span><span style="color:#eceff4">:</span> IfNotPresent
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> httpbin
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">ports</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#81a1c1">containerPort</span><span style="color:#eceff4">:</span> <span style="color:#b48ead">80</span>
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>Exec into the created container and install curl on it:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#81a1c1">exec</span> -it httpbin -- sh
</span></span><span style="display:flex;"><span>$ apt update<span style="color:#eceff4">;</span> apt install curl<span style="color:#eceff4">;</span>
</span></span></code></pre></div><h3 id="trying-it-out">Trying it out</h3>
<p>In order to try the Secret Manager API an OAuth2 token needs to be issued <a href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#applications"  target="_blank" rel="noreferrer noopener" >as we can read on the documentation.</a>
</p>
<blockquote>
<p>For some applications, you might need to request an OAuth2 access token and use it directly without going through a client library or using the gcloud or gsutil tools. There are several options for obtaining and using these access tokens to authenticate your applications. [&hellip;]
On the instance where your application runs, query the metadata server for an access token. [&hellip;]</p></blockquote>
<p>When inside the deployed container:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token -H <span style="color:#a3be8c">&#34;Metadata-Flavor: Google&#34;</span>
</span></span></code></pre></div><p>Since the OAuth2 scopes defined for the instances contains the <code>cloud-platform</code> one, the service account will be able to send requests towards Secret Manager API.</p>
<p>Copy the <code>access_token</code> from the response and execute the following call:</p>
<p><em>Remember to replace pablo-test-project with your project name.</em></p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://content-secretmanager.googleapis.com/v1beta1/projects/pablo-test-project/secrets/MY_SECRET/versions/latest:access -H <span style="color:#a3be8c">&#34;Authorization&#34;</span>:<span style="color:#a3be8c">&#34;Bearer &lt;access_token&gt;&#34;</span>
</span></span></code></pre></div><p>The response should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#81a1c1">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;name&#34;</span>: <span style="color:#a3be8c">&#34;projects/127553260172/secrets/MY_SECRET/versions/1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;payload&#34;</span>: <span style="color:#81a1c1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;data&#34;</span>: <span style="color:#a3be8c">&#34;czNjcjN0&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">}</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">}</span>
</span></span></code></pre></div><p>Decoding base64 <code>czNjcjN0</code> is <code>s3cr3t</code>.
This worked fine, but then do we need the IAM permission or is it just enough with the OAuth2 scope?</p>
<p>Remove the IAM permission from the service account:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud projects remove-iam-policy-binding pablo-test-project <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--member<span style="color:#81a1c1">=</span>serviceAccount:demo-service-account@pablo-test-project.iam.gserviceaccount.com <span style="color:#ebcb8b">\
</span></span></span><span style="display:flex;"><span><span style="color:#ebcb8b"></span>--role<span style="color:#81a1c1">=</span>roles/secretmanager.secretAccessor
</span></span></code></pre></div><p>Wait a minute until the change is propagated and issue the requests again. The response should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#81a1c1">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;error&#34;</span>: <span style="color:#81a1c1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;code&#34;</span>: 403,
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;message&#34;</span>: <span style="color:#a3be8c">&#34;Permission &#39;secretmanager.versions.access&#39; denied for resource &#39;projects/pablo-test-project/secrets/MY_SECRET/versions/latest&#39; (or it may not exist).&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a3be8c">&#34;status&#34;</span>: <span style="color:#a3be8c">&#34;PERMISSION_DENIED&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">}</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">}</span>
</span></span></code></pre></div><p>So effectively, the IAM role is required for this to work. Now, you can add the IAM role again for the next part.</p>
<h3 id="moving-this-to-a-more-realistic-scenario">Moving this to a more realistic scenario</h3>
<p>It is very important not to break the current workflow as this Secret Manager API is probably an overkill for local and dev environment. This is one of the selling points.</p>
<p>For this, I created a <a href="https://github.com/pmorelli92/secret-manager-demo"  target="_blank" rel="noreferrer noopener" >demo application</a>
 which is doing the following:</p>
<ul>
<li>Expects an environment variable named <code>GCP_PROJECT</code>, if the value is not present then it will try to read the keys from environment and use a default value when an environment variable is not found with the expected name.</li>
<li>If <code>GCP_PROJECT</code> is defined, it will try to search the secret on Secret Manager. If the value is not found there it will use a default value as well.</li>
<li>The application listens on the port <code>8080</code> and exposes the following route <code>GET /get-secret</code> expecting the header <code>secret: &lt;secret-name&gt;</code>.</li>
</ul>
<p>On the next section, this application is explained but for now we can just add it do the cluster:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>cat &lt;&lt;EOF | kubectl apply -f -
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">apiVersion</span><span style="color:#eceff4">:</span> v1
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">kind</span><span style="color:#eceff4">:</span> Pod
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">metadata</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> secret-manager
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">spec</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">containers</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#81a1c1">image</span><span style="color:#eceff4">:</span> docker.io/pmorelli92/secret-manager:latest
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">imagePullPolicy</span><span style="color:#eceff4">:</span> Always
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> secret-manager
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">ports</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#81a1c1">containerPort</span><span style="color:#eceff4">:</span> <span style="color:#b48ead">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">env</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> GCP_PROJECT
</span></span><span style="display:flex;"><span>      <span style="color:#81a1c1">value</span><span style="color:#eceff4">:</span> pablo-test-project
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>For simplicity, one can just port forward it:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl port-forward secret-manager 8080:8080
</span></span></code></pre></div><p>For existing secret:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:8080/get-secret -H <span style="color:#a3be8c">&#34;secret: MY_SECRET&#34;</span>
</span></span><span style="display:flex;"><span>&gt; <span style="color:#81a1c1">{</span><span style="color:#a3be8c">&#34;name&#34;</span>:<span style="color:#a3be8c">&#34;MY_SECRET&#34;</span>,<span style="color:#a3be8c">&#34;value&#34;</span>:<span style="color:#a3be8c">&#34;s3cr3t&#34;</span><span style="color:#81a1c1">}</span>
</span></span></code></pre></div><p>For non existing secret:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:8080/get-secret -H <span style="color:#a3be8c">&#34;secret: OTHER_SECRET&#34;</span>
</span></span><span style="display:flex;"><span>&gt; <span style="color:#81a1c1">{</span><span style="color:#a3be8c">&#34;name&#34;</span>:<span style="color:#a3be8c">&#34;MY_SECRET&#34;</span>,<span style="color:#a3be8c">&#34;value&#34;</span>:<span style="color:#a3be8c">&#34;default-for-OTHER_SECRET&#34;</span><span style="color:#81a1c1">}</span>
</span></span></code></pre></div><p>Now, let&rsquo;s do another test and deploy the pod without <code>GCP_PROJECT</code> environment variable but with the <code>MY_SECRET</code> one:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>kubectl delete pod secret-manager;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &lt;&lt;EOF | kubectl apply -f -
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">apiVersion</span><span style="color:#eceff4">:</span> v1
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">kind</span><span style="color:#eceff4">:</span> Pod
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">metadata</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> secret-manager
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">spec</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">containers</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#81a1c1">image</span><span style="color:#eceff4">:</span> docker.io/pmorelli92/secret-manager:latest
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">imagePullPolicy</span><span style="color:#eceff4">:</span> Always
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> secret-manager
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">ports</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#81a1c1">containerPort</span><span style="color:#eceff4">:</span> <span style="color:#b48ead">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">env</span><span style="color:#eceff4">:</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#81a1c1">name</span><span style="color:#eceff4">:</span> MY_SECRET
</span></span><span style="display:flex;"><span>      <span style="color:#81a1c1">value</span><span style="color:#eceff4">:</span> hello-from-env
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>Stop the port-forwarding, and execute it again:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl port-forward secret-manager 8080:8080
</span></span></code></pre></div><p>For existing secret:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:8080/get-secret -H <span style="color:#a3be8c">&#34;secret: MY_SECRET&#34;</span>
</span></span><span style="display:flex;"><span>&gt; <span style="color:#81a1c1">{</span><span style="color:#a3be8c">&#34;name&#34;</span>:<span style="color:#a3be8c">&#34;MY_SECRET&#34;</span>,<span style="color:#a3be8c">&#34;value&#34;</span>:<span style="color:#a3be8c">&#34;hello-from-env&#34;</span><span style="color:#81a1c1">}</span>
</span></span></code></pre></div><p>For non existing secret:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:8080/get-secret -H <span style="color:#a3be8c">&#34;secret: OTHER_SECRET&#34;</span>
</span></span><span style="display:flex;"><span>&gt; <span style="color:#81a1c1">{</span><span style="color:#a3be8c">&#34;name&#34;</span>:<span style="color:#a3be8c">&#34;MY_SECRET&#34;</span>,<span style="color:#a3be8c">&#34;value&#34;</span>:<span style="color:#a3be8c">&#34;default-for-OTHER_SECRET&#34;</span><span style="color:#81a1c1">}</span>
</span></span></code></pre></div><p>Easy, right?</p>
<h3 id="breakdown-the-demo-application">Breakdown the demo application</h3>
<p>The application is fairly easy. On startup it looks for the value of the <code>GCP_PROJECT</code> environment variable. This value is supplied to the <code>SecretGetter</code> struct which defines the <code>GetSecret</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">type</span> SecretGetter <span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	GoogleCloudProject <span style="color:#81a1c1">string</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">// GetSecret gets a secret either from environment variable or from GCP Secret Manager</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>sg SecretGetter<span style="color:#eceff4">)</span> <span style="color:#88c0d0">GetSecret</span><span style="color:#eceff4">(</span>name <span style="color:#81a1c1">string</span><span style="color:#eceff4">,</span> fallback <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">string</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// If GCP project is not present, get value from environment variables</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> sg<span style="color:#eceff4">.</span>GoogleCloudProject <span style="color:#81a1c1">==</span> <span style="color:#a3be8c">&#34;&#34;</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#88c0d0">getEnv</span><span style="color:#eceff4">(</span>name<span style="color:#eceff4">,</span> fallback<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#81a1c1">...</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">// getEnv returns the value for an environment value, or a fallback if not found</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">getEnv</span><span style="color:#eceff4">(</span>name <span style="color:#81a1c1">string</span><span style="color:#eceff4">,</span> fallback <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">string</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	value<span style="color:#eceff4">,</span> ok <span style="color:#81a1c1">:=</span> syscall<span style="color:#eceff4">.</span><span style="color:#88c0d0">Getenv</span><span style="color:#eceff4">(</span>name<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">!</span>ok <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> value
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>If <code>GoogleCloudProject</code> is empty, then the value will be taken from environment variables. Otherwise it does the following, shorten for brevity:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#eceff4">(</span>sg SecretGetter<span style="color:#eceff4">)</span> <span style="color:#88c0d0">GetSecret</span><span style="color:#eceff4">(</span>name <span style="color:#81a1c1">string</span><span style="color:#eceff4">,</span> fallback <span style="color:#81a1c1">string</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">string</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// If GCP project is not present, get value from environment variables</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> sg<span style="color:#eceff4">.</span>GoogleCloudProject <span style="color:#81a1c1">==</span> <span style="color:#a3be8c">&#34;&#34;</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#88c0d0">getEnv</span><span style="color:#eceff4">(</span>name<span style="color:#eceff4">,</span> fallback<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// Get the token for the service account that runs the node pool</span>
</span></span><span style="display:flex;"><span>	tokenUrl <span style="color:#81a1c1">:=</span> <span style="color:#a3be8c">&#34;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token&#34;</span>
</span></span><span style="display:flex;"><span>	rq<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> http<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewRequest</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>MethodGet<span style="color:#eceff4">,</span> tokenUrl<span style="color:#eceff4">,</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span>err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// Get the secret value using the access_token that we fetched above</span>
</span></span><span style="display:flex;"><span>	secretUrl <span style="color:#81a1c1">:=</span> fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a3be8c">&#34;https://content-secretmanager.googleapis.com/v1beta1/projects/%s/secrets/%s/versions/latest:access&#34;</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>		sg<span style="color:#eceff4">.</span>GoogleCloudProject<span style="color:#eceff4">,</span> name<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	rq<span style="color:#eceff4">,</span> err <span style="color:#eceff4">=</span> http<span style="color:#eceff4">.</span><span style="color:#88c0d0">NewRequest</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>MethodGet<span style="color:#eceff4">,</span> secretUrl<span style="color:#eceff4">,</span> <span style="color:#81a1c1;font-weight:bold">nil</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span>err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rq<span style="color:#eceff4">.</span>Header<span style="color:#eceff4">.</span><span style="color:#88c0d0">Add</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Authorization&#34;</span><span style="color:#eceff4">,</span> fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Bearer %s&#34;</span><span style="color:#eceff4">,</span> tokenResponse<span style="color:#eceff4">.</span>AccessToken<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>	rs<span style="color:#eceff4">,</span> err <span style="color:#eceff4">=</span> http<span style="color:#eceff4">.</span>DefaultClient<span style="color:#eceff4">.</span><span style="color:#88c0d0">Do</span><span style="color:#eceff4">(</span>rq<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span>err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	secretResponse <span style="color:#81a1c1">:=</span> <span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		Error   <span style="color:#81a1c1">int</span>    <span style="color:#a3be8c">`json:&#34;error&#34;`</span>
</span></span><span style="display:flex;"><span>		Status  <span style="color:#81a1c1">string</span> <span style="color:#a3be8c">`json:&#34;status&#34;`</span>
</span></span><span style="display:flex;"><span>		Payload <span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			Data <span style="color:#81a1c1">string</span> <span style="color:#a3be8c">`json:&#34;data&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span> <span style="color:#a3be8c">`json:&#34;payload&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// In case there is an error because of privileges or oauth scopes, return the fallback</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> secretResponse<span style="color:#eceff4">.</span>Error <span style="color:#81a1c1">!=</span> <span style="color:#b48ead">0</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span>fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;error %d - status %s&#34;</span><span style="color:#eceff4">,</span> secretResponse<span style="color:#eceff4">.</span>Error<span style="color:#eceff4">,</span> secretResponse<span style="color:#eceff4">.</span>Status<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// Secret Manager returns the secret on base64</span>
</span></span><span style="display:flex;"><span>	data<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> base64<span style="color:#eceff4">.</span>StdEncoding<span style="color:#eceff4">.</span><span style="color:#88c0d0">DecodeString</span><span style="color:#eceff4">(</span>secretResponse<span style="color:#eceff4">.</span>Payload<span style="color:#eceff4">.</span>Data<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Println</span><span style="color:#eceff4">(</span>err<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> fallback
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1">string</span><span style="color:#eceff4">(</span>data<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>And then for the API handler:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">// getSecretHandler gets the secret value according to the name sent on the header</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">func</span> <span style="color:#88c0d0">getSecretHandler</span><span style="color:#eceff4">(</span>secretGetter SecretGetter<span style="color:#eceff4">)</span> http<span style="color:#eceff4">.</span>HandlerFunc <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#81a1c1;font-weight:bold">func</span><span style="color:#eceff4">(</span>w http<span style="color:#eceff4">.</span>ResponseWriter<span style="color:#eceff4">,</span> rq <span style="color:#81a1c1">*</span>http<span style="color:#eceff4">.</span>Request<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Only work with GET requests</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">if</span> rq<span style="color:#eceff4">.</span>Method <span style="color:#81a1c1">!=</span> http<span style="color:#eceff4">.</span>MethodGet <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusMethodNotAllowed<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Fetch the secret name on the header</span>
</span></span><span style="display:flex;"><span>		secretName <span style="color:#81a1c1">:=</span> rq<span style="color:#eceff4">.</span>Header<span style="color:#eceff4">.</span><span style="color:#88c0d0">Get</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;secret&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">if</span> secretName <span style="color:#81a1c1">==</span> <span style="color:#a3be8c">&#34;&#34;</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusBadRequest<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Create the struct definition for the response</span>
</span></span><span style="display:flex;"><span>		bytes<span style="color:#eceff4">,</span> err <span style="color:#81a1c1">:=</span> json<span style="color:#eceff4">.</span><span style="color:#88c0d0">Marshal</span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">struct</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			Name  <span style="color:#81a1c1">string</span> <span style="color:#a3be8c">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>			Value <span style="color:#81a1c1">string</span> <span style="color:#a3be8c">`json:&#34;value&#34;`</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}{</span>
</span></span><span style="display:flex;"><span>			Name<span style="color:#eceff4">:</span> secretName<span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#616e87;font-style:italic">// Use the secret getter to get the secret or the fallback</span>
</span></span><span style="display:flex;"><span>			Value<span style="color:#eceff4">:</span> secretGetter<span style="color:#eceff4">.</span><span style="color:#88c0d0">GetSecret</span><span style="color:#eceff4">(</span>secretName<span style="color:#eceff4">,</span> fmt<span style="color:#eceff4">.</span><span style="color:#88c0d0">Sprintf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;default-for-%s&#34;</span><span style="color:#eceff4">,</span> secretName<span style="color:#eceff4">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">if</span> err <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1;font-weight:bold">nil</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>			w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusInternalServerError<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#81a1c1;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#616e87;font-style:italic">// Return the secret value</span>
</span></span><span style="display:flex;"><span>		w<span style="color:#eceff4">.</span><span style="color:#88c0d0">Header</span><span style="color:#eceff4">().</span><span style="color:#88c0d0">Set</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Content-Type&#34;</span><span style="color:#eceff4">,</span> <span style="color:#a3be8c">&#34;application/json&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		w<span style="color:#eceff4">.</span><span style="color:#88c0d0">WriteHeader</span><span style="color:#eceff4">(</span>http<span style="color:#eceff4">.</span>StatusOK<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		_<span style="color:#eceff4">,</span> _ <span style="color:#eceff4">=</span> w<span style="color:#eceff4">.</span><span style="color:#88c0d0">Write</span><span style="color:#eceff4">(</span>bytes<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Of course there is a catch. When working on local environment if the value for <code>GCP_PROJECT</code> is set, then only the default value will be returned as the call to get the token of the instance running inside GCP will fail:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Get <span style="color:#a3be8c">&#34;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token&#34;</span>: dial tcp: lookup metadata.google.internal: no such host
</span></span></code></pre></div><h3 id="summary">Summary</h3>
<ul>
<li>(+) Secret Manager has a very intuitive API which also has some nice dedicated UI for developers to access secrets (if they also have the required IAM), see key versions and configure policies for expiration.</li>
<li>(+) Moving away from storing secrets on plain text on environment variables is also a correct step in order to secure our applications.</li>
<li>(+) Having the possibility to implement this in a way where it does not interfere with the local environment is one of the selling points.</li>
<li>(-) Vendor lockdown. It is understandable that this product is not directly interchangeable. That being said there are alternatives like Hashicorp Vault that also offers the same (and maybe more) functionality. However, it is clear that if you are on GCP you have already invested time on using cloud specific built-in solutions like CloudSQL and Cloud Storage which are not directly interchangeable either.</li>
</ul>
<h3 id="demo-application-repository">Demo application repository</h3>
<p><a href="https://github.com/pmorelli92/secret-manager-demo"  target="_blank" rel="noreferrer noopener" >👉 Repository 👈</a>
</p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://devandchill.com/tags/secrets/">secrets</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/environment/">environment</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/env/">env</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/variable/">variable</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/gcp/">gcp</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/manager/">manager</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/secret-manager/">secret manager</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/kubernetes/">kubernetes</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/gcloud/">gcloud</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/iam/">iam</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/gke/">gke</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        2008 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2020-08-31 21:00 &#43;0200
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        
        <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
        </div>
        

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://devandchill.com/posts/2020/11/the-good-the-bad-and-the-ugly-of-microservices/">
                    <span class="button__icon">←</span>
                    <span class="button__text">The good, the bad and the ugly of microservices</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://devandchill.com/posts/2020/05/go-lib/pq-or-pgx-which-performs-better/">
                    <span class="button__text">Go - lib/pq or pgx - which performs better?</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        


<script type="text/javascript" src="/bundle.min.2c9c676130329bfc6d81ffbc7aa868a0297c372efaa0480153e69a8c4fc512933e60b51061bd4b7108b4ce279a4a88037a7039e4129ea4c5744d10a320294886.js" integrity="sha512-LJxnYTAym/xtgf&#43;8eqhooCl8Ny76oEgBU&#43;aajE/FEpM&#43;YLUQYb1LcQi0zieaSogDenA55BKepMV0TRCjIClIhg=="></script>




    </body>
</html>
