<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Pablo Morelli">
<meta name="description" content="Devandchill is a coding blog where I share my ideas and insights on various programming topics." />
<meta name="keywords"
    content="blog, development, programming, tech, postgres, database, sql, benchmark, upsert, queries, cte, concurrency" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://devandchill.com/posts/2020/02/postgres-building-concurrently-safe-upsert-queries/" />


<title>
    
    Postgres: Building concurrently safe upsert queries :: Dev &amp; Chill  — A blog about coding
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" type="text/css" href="/main.045f18da88f8cb42336977558c8919c77ba0afb78827b7a1250d971d6cfd080e.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Postgres: Building concurrently safe upsert queries">
<meta itemprop="description" content="Recently at the company I am working for, there was a need to communicate with an external service which required us to send some data along with an integer identifier. The problem is that IDs in our domain are not integers but uuid.
The suggestion then was to have a service which creates an unique integer for a certain uuid. This way the int identifier won&rsquo;t be leaked to any other part of the system."><meta itemprop="datePublished" content="2020-02-16T09:22:29+01:00" />
<meta itemprop="dateModified" content="2020-02-16T09:22:29+01:00" />
<meta itemprop="wordCount" content="2080"><meta itemprop="image" content="https://devandchill.com/og-image.png"/>
<meta itemprop="keywords" content="postgres,database,sql,benchmark,upsert,queries,cte,concurrency," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://devandchill.com/og-image.png"/>

<meta name="twitter:title" content="Postgres: Building concurrently safe upsert queries"/>
<meta name="twitter:description" content="Recently at the company I am working for, there was a need to communicate with an external service which required us to send some data along with an integer identifier. The problem is that IDs in our domain are not integers but uuid.
The suggestion then was to have a service which creates an unique integer for a certain uuid. This way the int identifier won&rsquo;t be leaked to any other part of the system."/>







<meta property="article:published_time" content="2020-02-16 09:22:29 &#43;0100 CET" />







<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138171880-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138171880-1');
</script>



    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <img src="/dev-n-chill-logo.svg" alt="Dev &amp; Chill" />
        
    </div>
</a>


        <span class="header__right">
            
            <nav class="menu">
    <ul class="menu__inner"><li><a href="/blog">The blog</a></li><li><a href="/resume">Resume</a></li><li><a href="/posts">Posts</a></li>
    </ul>
</nav>

            <span class="menu-trigger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">

  <div class="post-info">
    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-clock">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      10 minutes

      
    </p>
  </div>

  <article>
    <h1 class="post-title">
      <a href="https://devandchill.com/posts/2020/02/postgres-building-concurrently-safe-upsert-queries/">Postgres: Building concurrently safe upsert queries</a>
    </h1>

    

    

    

    <div class="post-content">
      <p>Recently at the company I am working for, there was a need to communicate with an external service which required us to send some data along with an integer identifier. The problem is that IDs in our domain are not integers but uuid.</p>
<p>The suggestion then was to have a service which creates an unique integer for a certain uuid. This way the int identifier won&rsquo;t be leaked to any other part of the system.</p>
<figure><img src="/posts/images/intgen.png"/>
</figure>

<ol>
<li>Internal system does a request to the integer generator.</li>
<li>This service will generate the int representation for certain uuid.</li>
<li>Internal system does a request to external service sending the int ID.</li>
</ol>
<p>That is fairly simple, but lets go through some more elaborated preconditions:</p>
<ol>
<li>For x uuid there will always be a unique y int.</li>
<li>If the int representation is not created, create it.</li>
<li>If the int representation is created, return it.</li>
<li>The code should be concurrently safe.</li>
</ol>
<p>In this part of the series, different approaches are being listed. For obvious reasons these ones are not based on real business. Benchmarking is going to be displayed on the next part for the approaches 3, 4 and 5.</p>
<h3 id="data-model">Data Model</h3>
<p>Just to have more context on the snippets below, the database model will be the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">CREATE</span> <span style="color:#81a1c1;font-weight:bold">TABLE</span> customers
</span></span><span style="display:flex;"><span><span style="color:#eceff4">(</span>
</span></span><span style="display:flex;"><span>  id <span style="color:#81a1c1">SERIAL</span><span style="color:#eceff4">,</span>
</span></span><span style="display:flex;"><span>  customer_id UUID <span style="color:#81a1c1;font-weight:bold">NOT</span> <span style="color:#81a1c1;font-weight:bold">NULL</span> <span style="color:#81a1c1;font-weight:bold">PRIMARY</span> <span style="color:#81a1c1;font-weight:bold">KEY</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">);</span>
</span></span></code></pre></div><p>The approaches below are possible implementations for the <code>integer-generator</code>.</p>
<h3 id="1-read--write">1. Read + write</h3>
<ol>
<li>Receive the <code>POST</code> request, parse the uuid.</li>
<li>Execute query:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> customers
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span>
</span></span></code></pre></div><ol start="3">
<li>If the previous query returned a row, return the id.</li>
<li>If not, insert the row and return the id:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>RETURNING id
</span></span></code></pre></div><p>The problem with this approach is that if we get two consecutive calls hitting the <code>SELECT</code> at the same time while there is no row, both will try to add the row in the database. One will succeed and the other is going to fail.</p>
<p>This can be fixed changing the insert to the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">ON</span> CONFLICT <span style="color:#81a1c1;font-weight:bold">DO</span> <span style="color:#81a1c1;font-weight:bold">NOTHING</span>
</span></span><span style="display:flex;"><span>RETURNING id
</span></span></code></pre></div><p><code>ON CONFLICT DO NOTHING</code> will avoid the primary key exception! Yes, that is true, but when this clause does not update the row (<code>DO NOTHING</code>) the <code>RETURNING</code> row will be empty.</p>
<p>This can be tested by executing several times the statement in point 4.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#eceff4">|</span> id <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> -- <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#b48ead">1</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span>    <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span>    <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span>    <span style="color:#eceff4">|</span>
</span></span></code></pre></div><hr>
<h3 id="2-enter-transaction-read--write">2. Enter transaction: read + write</h3>
<p>Same scenario than the one detailed above, but starting a transaction before executing the <code>SELECT</code>, and committing after the insert succeed.</p>
<p>Unfortunately, transaction is not going to help in any way here. The <code>SELECT</code> will not lock any row because no row exists and this is not exactly the way Postgres handles locking. This means that two <code>SELECT</code> at the same time will not cause the latest to wait until the first transaction is committed.</p>
<hr>
<h3 id="3-transaction-advisory-lock--read--write">3. Transaction: advisory lock + read + write</h3>
<ol>
<li>Receive the <code>POST</code> request, parse the uuid.</li>
<li>Begin the transaction:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">BEGIN</span>
</span></span></code></pre></div><ol start="3">
<li>Get a lock using a numeric hash that represents x uuid in a deterministic way:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> pg_advisory_xact_lock<span style="color:#eceff4">(</span><span style="color:#81a1c1">&lt;</span><span style="color:#81a1c1">bigint</span><span style="color:#81a1c1">&gt;</span><span style="color:#eceff4">)</span>
</span></span></code></pre></div><ol start="4">
<li>Execute query:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> customers
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span>
</span></span></code></pre></div><ol start="5">
<li>If the previous query returned a row, return the id.</li>
<li>If not, insert the row and return the id:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>RETURNING id
</span></span></code></pre></div><ol start="6">
<li>Commit transaction:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">COMMIT</span>
</span></span></code></pre></div><p>Ok, now this works. But this is still far away from a good design. In the previous approach, the race condition existed because there was nothing to lock when there was no row to be found.</p>
<p>In this approach, for certain uuid the same numeric hash will be generated. When starting a transaction, an exclusive transaction level advisory lock is obtained. If another transaction wants to execute the lock query using the same hash, it will have to wait until the first transaction ends with a commit or rollback.</p>
<p>How to try this out?</p>
<ul>
<li>Open a database connection.</li>
<li>Execute:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">BEGIN</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> pg_advisory_xact_lock<span style="color:#eceff4">(</span><span style="color:#b48ead">12345</span><span style="color:#eceff4">);</span>
</span></span></code></pre></div><ul>
<li>Open another database connection.</li>
<li>Execute:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">BEGIN</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> pg_advisory_xact_lock<span style="color:#eceff4">(</span><span style="color:#b48ead">12345</span><span style="color:#eceff4">);</span>
</span></span></code></pre></div><ul>
<li>This last query will not respond until the first transaction finishes.</li>
</ul>
<p>What does this mean? It means that concurrency is being handled explicitly with locks in a way that won&rsquo;t scale when having multiple requests using the same uuid.</p>
<p><a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/"  target="_blank" rel="noreferrer noopener" ><em>Benchmark for this approach in part 2</em></a>
</p>
<hr>
<h3 id="4-on-conflict-update">4. On conflict, update</h3>
<ol>
<li>Receive the <code>POST</code> request, parse the uuid.</li>
<li>Execute the query and return the result. This query will insert the row if it does not exist; and in case it does, it will just return the id. The update is required to return the desired id.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">ON</span> CONFLICT <span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">DO</span> <span style="color:#81a1c1;font-weight:bold">UPDATE</span> <span style="color:#81a1c1;font-weight:bold">SET</span> customer_id <span style="color:#81a1c1">=</span> excluded<span style="color:#eceff4">.</span>customer_id
</span></span><span style="display:flex;"><span>RETURNING id
</span></span></code></pre></div><p>The difference between the first example and this one, is that now the <code>DO NOTHING</code> is replaced by <code>DO UPDATE</code> and since an update is being executed; the returning row will never be empty. Moreover the concurrency problems are gone because they are handled by the database and not by code. This can be tested by executing several times the query.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#eceff4">|</span> id <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> -- <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#b48ead">3</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#b48ead">3</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#b48ead">3</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#b48ead">3</span>  <span style="color:#eceff4">|</span>
</span></span></code></pre></div><p>As simple as that. Looks great doesn&rsquo;t it? Well I thought so until a colleague proved me wrong when he linked this <a href="https://stackoverflow.com/a/42217872"  target="_blank" rel="noreferrer noopener" >awesome stack overflow answer</a>
.</p>
<blockquote>
<p>[&hellip;] Do not update identical rows without need. Even if you see no difference on the surface, there are various side effects:</p>
<ul>
<li>It might fire triggers that should not be fired.</li>
<li>It write-locks &ldquo;innocent&rdquo; rows, possibly incurring costs for concurrent transactions.</li>
<li>It might make the row seem new, though it&rsquo;s old (transaction timestamp).</li>
</ul>
</blockquote>
<p>How can one be sure that this is true?
Executing the following query 5 times!</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d269&#39;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">ON</span> CONFLICT <span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">DO</span> <span style="color:#81a1c1;font-weight:bold">UPDATE</span> <span style="color:#81a1c1;font-weight:bold">SET</span> customer_id <span style="color:#81a1c1">=</span> excluded<span style="color:#eceff4">.</span>customer_id
</span></span><span style="display:flex;"><span>RETURNING ctid<span style="color:#eceff4">,</span> xmin<span style="color:#eceff4">,</span> xmax<span style="color:#eceff4">,</span> id
</span></span></code></pre></div><p>Results:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#eceff4">|</span> ctid  <span style="color:#eceff4">|</span> xmin <span style="color:#eceff4">|</span> xmax <span style="color:#eceff4">|</span> id <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> ----- <span style="color:#eceff4">|</span> ---- <span style="color:#eceff4">|</span> ---- <span style="color:#eceff4">|</span> -- <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#81a1c1">(</span>0,1<span style="color:#81a1c1">)</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5876</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">0</span>    <span style="color:#eceff4">|</span> <span style="color:#b48ead">2</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#81a1c1">(</span>0,2<span style="color:#81a1c1">)</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5877</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5877</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">2</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#81a1c1">(</span>0,3<span style="color:#81a1c1">)</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5878</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5878</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">2</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#81a1c1">(</span>0,4<span style="color:#81a1c1">)</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5879</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5879</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">2</span>  <span style="color:#eceff4">|</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">|</span> <span style="color:#81a1c1">(</span>0,5<span style="color:#81a1c1">)</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5880</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">5880</span> <span style="color:#eceff4">|</span> <span style="color:#b48ead">2</span>  <span style="color:#eceff4">|</span>
</span></span></code></pre></div><p>What is the definition of <code>ctid</code>, <code>xmin</code> and <code>xmax</code>, and why do they keep increasing?
<a href="https://www.postgresql.org/docs/8.2/ddl-system-columns.html"  target="_blank" rel="noreferrer noopener" >Documentation</a>
</p>
<p><strong>ctid</strong></p>
<blockquote>
<p>The physical location of the row version within its table. Note that although the ctid can be used to locate the row version very quickly, a row&rsquo;s ctid will change if it is updated or moved by VACUUM FULL. Therefore ctid is useless as a long-term row identifier. A primary key should be used to identify logical rows.</p>
</blockquote>
<p><strong>xmin</strong></p>
<blockquote>
<p>The identity (transaction ID) of the inserting transaction for this row version. (A row version is an individual state of a row; each update of a row creates a new row version for the same logical row.)</p>
</blockquote>
<p><strong>xmax</strong></p>
<blockquote>
<p>The identity (transaction ID) of the deleting transaction, or zero for an undeleted row version. It is possible for this column to be nonzero in a visible row version. That usually indicates that the deleting transaction hasn&rsquo;t committed yet, or that an attempted deletion was rolled back.</p>
</blockquote>
<p>Summary:</p>
<ul>
<li><code>ctid</code> is the tuple id composed by <code>(page, item)</code>.</li>
<li><code>xmin</code> is the creation transaction id of that row.</li>
<li><code>xmax</code> is the destruction transaction id of that row.</li>
</ul>
<p>In order to elaborate it is important to take into consideration the MVCC (Multiversion Concurrency Control) nature of postgres. From the <a href="https://www.postgresql.org/docs/current/mvcc-intro.html"  target="_blank" rel="noreferrer noopener" >Documentation</a>
:</p>
<blockquote>
<p>Each SQL statement sees a snapshot of data [&hellip;] regardless of the current state of the underlying data. This prevents statements from viewing inconsistent data produced by concurrent transactions performing updates on the same data rows. [&hellip;] MVCC, minimizes lock contention in order to allow for reasonable performance in multiuser environments.</p>
</blockquote>
<blockquote>
<p>The main advantage of using the MVCC model of concurrency control rather than locking is [&hellip;] reading never blocks writing and writing never blocks reading.</p>
</blockquote>
<p>With that explained, lets introduce how an UPDATE works on postgres:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">CREATE</span> EXTENSION pageinspect<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d271&#39;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> t_ctid<span style="color:#eceff4">,</span> t_xmin<span style="color:#eceff4">,</span> t_xmax
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> heap_page_items<span style="color:#eceff4">(</span>get_raw_page<span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;customers&#39;</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">|</span> t_ctid  <span style="color:#81a1c1">|</span> t_xmin <span style="color:#81a1c1">|</span> t_xmax <span style="color:#81a1c1">|</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">|</span> <span style="color:#616e87;font-style:italic">------- | ------ | ------ |
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span><span style="color:#81a1c1">|</span> <span style="color:#eceff4">(</span><span style="color:#b48ead">0</span><span style="color:#eceff4">,</span><span style="color:#b48ead">1</span><span style="color:#eceff4">)</span>   <span style="color:#81a1c1">|</span> <span style="color:#b48ead">5919</span>   <span style="color:#81a1c1">|</span> <span style="color:#b48ead">0</span>      <span style="color:#81a1c1">|</span>
</span></span></code></pre></div><ul>
<li><code>t_ctid</code> indicates that the row is stored on page 0 and block 1.</li>
<li>The transaction id used for the creation of the row (<code>t_xmin</code>) is 5919.</li>
<li>The destruction transaction id (<code>t_xmax</code>) is 0 because no changes happened to the row.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">UPDATE</span> customers
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SET</span> customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d271&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d271&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> t_ctid<span style="color:#eceff4">,</span> t_xmin<span style="color:#eceff4">,</span> t_xmax
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> heap_page_items<span style="color:#eceff4">(</span>get_raw_page<span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;customers&#39;</span><span style="color:#eceff4">,</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">|</span> t_ctid  <span style="color:#81a1c1">|</span> t_xmin <span style="color:#81a1c1">|</span> t_xmax <span style="color:#81a1c1">|</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">|</span> <span style="color:#616e87;font-style:italic">------- | ------ | ------ |
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span><span style="color:#81a1c1">|</span> <span style="color:#eceff4">(</span><span style="color:#b48ead">0</span><span style="color:#eceff4">,</span><span style="color:#b48ead">2</span><span style="color:#eceff4">)</span>   <span style="color:#81a1c1">|</span> <span style="color:#b48ead">5919</span>   <span style="color:#81a1c1">|</span> <span style="color:#b48ead">5920</span>   <span style="color:#81a1c1">|</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">|</span> <span style="color:#eceff4">(</span><span style="color:#b48ead">0</span><span style="color:#eceff4">,</span><span style="color:#b48ead">2</span><span style="color:#eceff4">)</span>   <span style="color:#81a1c1">|</span> <span style="color:#b48ead">5920</span>   <span style="color:#81a1c1">|</span> <span style="color:#b48ead">0</span>      <span style="color:#81a1c1">|</span>
</span></span></code></pre></div><p>Row #1</p>
<ul>
<li><code>t_ctid</code> indicates that the row is stored on page 0 and block 2.</li>
<li>The transaction id used for the creation of the row (<code>t_xmin</code>) is 5919.</li>
<li>The destruction transaction id (<code>t_xmax</code>) is 5920 because the row was <code>DELETED</code>.</li>
</ul>
<p>Row #2</p>
<ul>
<li><code>t_ctid</code> indicates that the row is stored on page 0 and block 2.</li>
<li>The transaction id used for the creation of the row (<code>t_xmin</code>) is 5920.</li>
<li>The destruction transaction id (<code>t_xmax</code>) is 0 because no changes happened to the row.</li>
</ul>
<p>As you can probably guess an <code>UPDATE</code> is a <code>DELETE + INSERT</code> under the hoods.</p>
<p>With this explained, it is confirmed why doing <code>ON CONFLICT UPDATE</code> is not a good choice either.</p>
<p><a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/"  target="_blank" rel="noreferrer noopener" ><em>Benchmark for this approach in part 2</em></a>
</p>
<hr>
<h3 id="5-insert-first-read-later">5. Insert first, read later</h3>
<p>On the first approach, the problem was that the <code>INSERT</code> query was not updating on conflict, thus the <code>RETURNING</code> row is empty when the row already exists. This can be solved by flipping the order of the statements.</p>
<ol>
<li>Receive the <code>POST</code> request, parse the uuid.</li>
<li>Execute query:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers<span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">VALUES</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">ON</span> CONFLICT <span style="color:#81a1c1;font-weight:bold">DO</span> <span style="color:#81a1c1;font-weight:bold">NOTHING</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">FROM</span> customers
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WHERE</span> customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;1796b892-c988-4f96-8eb8-a7f6f965d266&#39;</span>
</span></span></code></pre></div><p>It does not matter how many concurrent inserts are triggered at the same time, only the first one will get through and insert the row. Since the row is never updated (<code>ON CONFLICT DO NOTHING</code>) the <code>ctid</code>, <code>xmin</code>, and <code>xmax</code> will remain the same.</p>
<p>After the <code>INSERT</code> is executed, the <code>SELECT</code> statement will return the id for the recently created / already existing row.</p>
<p>But is this performing? For that lets <code>EXPLAIN ANALYZE</code> the queries:</p>
<p>Insert (when there is no row):</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Insert on customers
</span></span><span style="display:flex;"><span>  Conflict Resolution: NOTHING
</span></span><span style="display:flex;"><span>  Tuples Inserted: <span style="color:#b48ead">1</span>
</span></span><span style="display:flex;"><span>  Conflicting Tuples: <span style="color:#b48ead">0</span>
</span></span><span style="display:flex;"><span>Planning Time: 0.032 ms
</span></span><span style="display:flex;"><span>Execution Time: 0.190 ms
</span></span></code></pre></div><p>Insert (when there is a conflict):</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Insert on customers
</span></span><span style="display:flex;"><span>  Conflict Resolution: NOTHING
</span></span><span style="display:flex;"><span>  Tuples Inserted: <span style="color:#b48ead">0</span>
</span></span><span style="display:flex;"><span>  Conflicting Tuples: <span style="color:#b48ead">1</span>
</span></span><span style="display:flex;"><span>  -&gt;  Result
</span></span><span style="display:flex;"><span>Planning Time: 0.032 ms
</span></span><span style="display:flex;"><span>Execution Time: 0.244 ms
</span></span></code></pre></div><p>Select query:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Index Scan using customers_pkey on customers
</span></span><span style="display:flex;"><span>  Index Cond: <span style="color:#81a1c1">(</span>customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;...&#39;</span>::uuid<span style="color:#81a1c1">)</span>
</span></span><span style="display:flex;"><span>Planning Time: 0.069 ms
</span></span><span style="display:flex;"><span>Execution Time: 0.111 ms
</span></span></code></pre></div><p>The summarization between the insert and the select is less than a millisecond for both cases. Don&rsquo;t worry, on the next part this is proven.</p>
<p><a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/"  target="_blank" rel="noreferrer noopener" ><em>Benchmark for this approach in part 2</em></a>
</p>
<hr>
<h3 id="bonus-for-non-postgres-users-aka-cte-queries">Bonus for non Postgres users (a.k.a CTE queries)</h3>
<p>CTE means Common Table Expression and documentation can be found <a href="https://www.postgresql.org/docs/current/queries-with.html"  target="_blank" rel="noreferrer noopener" >here</a>
</p>
<p>These kind of expressions are also useful when the database engine  does not support <code>ON CONFLICT DO NOTHING</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">WITH</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">search</span> <span style="color:#81a1c1;font-weight:bold">AS</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">SELECT</span> ctid<span style="color:#eceff4">,</span> xmax<span style="color:#eceff4">,</span> id <span style="color:#81a1c1;font-weight:bold">FROM</span> customers <span style="color:#81a1c1;font-weight:bold">WHERE</span> customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;8a57f8f4-aeed-412c-a6f6-5f9a03b17bc5&#39;</span> <span style="color:#81a1c1;font-weight:bold">LIMIT</span> <span style="color:#b48ead">1</span><span style="color:#eceff4">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">add</span> <span style="color:#81a1c1;font-weight:bold">AS</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">INSERT</span> <span style="color:#81a1c1;font-weight:bold">INTO</span> customers <span style="color:#eceff4">(</span>customer_id<span style="color:#eceff4">)</span> <span style="color:#81a1c1;font-weight:bold">SELECT</span> <span style="color:#a3be8c">&#39;8a57f8f4-aeed-412c-a6f6-5f9a03b17bc5&#39;</span> <span style="color:#81a1c1;font-weight:bold">WHERE</span> <span style="color:#81a1c1;font-weight:bold">NOT</span> <span style="color:#81a1c1;font-weight:bold">EXISTS</span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">SELECT</span> id <span style="color:#81a1c1;font-weight:bold">from</span> <span style="color:#81a1c1;font-weight:bold">search</span><span style="color:#eceff4">)</span> RETURNING ctid<span style="color:#eceff4">,</span> xmax<span style="color:#eceff4">,</span> id<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1;font-weight:bold">SELECT</span> ctid<span style="color:#eceff4">,</span> xmax<span style="color:#eceff4">,</span> id <span style="color:#81a1c1;font-weight:bold">from</span> <span style="color:#81a1c1;font-weight:bold">add</span>	<span style="color:#81a1c1;font-weight:bold">UNION</span> <span style="color:#81a1c1;font-weight:bold">ALL</span> <span style="color:#81a1c1;font-weight:bold">SELECT</span> ctid<span style="color:#eceff4">,</span> xmax<span style="color:#eceff4">,</span> id <span style="color:#81a1c1;font-weight:bold">from</span> <span style="color:#81a1c1;font-weight:bold">search</span>
</span></span></code></pre></div><ul>
<li>Prepare the <code>search</code> statement, it will be responsible of finding a customer given an id.</li>
<li>Prepare the <code>add</code> statement, it will insert the customer if it is not found on the search expression.</li>
<li>Execute both statements, only one will return a result.</li>
</ul>
<p>Running <code>EXPLAIN ANALYZE</code> on the query:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HashAggregate
</span></span><span style="display:flex;"><span>  Group Key: add.ctid, add.xmax, add.id
</span></span><span style="display:flex;"><span>  CTE search
</span></span><span style="display:flex;"><span>    -&gt;  Limit
</span></span><span style="display:flex;"><span>          -&gt;  Index Scan using customers_pkey on customers
</span></span><span style="display:flex;"><span>                Index Cond: <span style="color:#81a1c1">(</span>customer_id <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;...&#39;</span>::uuid<span style="color:#81a1c1">)</span>
</span></span><span style="display:flex;"><span>  CTE add
</span></span><span style="display:flex;"><span>    -&gt;  Insert on customers customers_1
</span></span><span style="display:flex;"><span>          InitPlan <span style="color:#b48ead">2</span> <span style="color:#81a1c1">(</span>returns $1<span style="color:#81a1c1">)</span>
</span></span><span style="display:flex;"><span>            -&gt;  CTE Scan on search search_1
</span></span><span style="display:flex;"><span>          -&gt;  Result
</span></span><span style="display:flex;"><span>                One-Time Filter: <span style="color:#81a1c1">(</span>NOT $1<span style="color:#81a1c1">)</span>
</span></span><span style="display:flex;"><span>  -&gt;  Append
</span></span><span style="display:flex;"><span>        -&gt;  CTE Scan on add
</span></span><span style="display:flex;"><span>        -&gt;  CTE Scan on search
</span></span><span style="display:flex;"><span>Planning Time: 0.256 ms
</span></span><span style="display:flex;"><span>Execution Time: 2.483 ms
</span></span></code></pre></div><p><a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/"  target="_blank" rel="noreferrer noopener" ><em>Benchmark for this approach in part 2</em></a>
</p>
<hr>
<p>And that is all for this post. On the next post, the benchmarks for the following approaches are going to be executed:</p>
<ul>
<li>Advisory lock</li>
<li>On conflict update</li>
<li>On conflict do nothing</li>
<li>CTE queries</li>
</ul>
<p>If you consider this is useful, do not hesitate on sharing this on your favorite social media. See you next time!</p>

    </div>
  </article>

  <hr />

  <div class="post-info">
    
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://devandchill.com/tags/postgres/">postgres</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/database/">database</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/sql/">sql</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/benchmark/">benchmark</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/upsert/">upsert</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/queries/">queries</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/cte/">cte</a></span>
        <span class="tag"><a href="https://devandchill.com/tags/concurrency/">concurrency</a></span>
        
    </p>

    

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-file-text">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      2080 Words
    </p>

    <p>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="feather feather-calendar">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      
      2020-02-16 09:22 &#43;0100
      

      
      
      
    </p>
  </div>

  
  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">Read other posts</span>
      <hr />
    </div>

    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="https://devandchill.com/posts/2020/05/postgres-benchmarking-concurrently-safe-upsert-queries/">
          <span class="button__icon">←</span>
          <span class="button__text">Postgres: Benchmarking concurrently safe upsert queries</span>
        </a>
      </span>
      

      
      <span class="button next">
        <a href="https://devandchill.com/posts/2019/10/azure-pipelines-build-a-dockerized-app-and-deploy-to-kubernetes/">
          <span class="button__text">Azure Pipelines: Build a dockerized app and deploy to kubernetes</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  
  

  
  

</main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        


<script type="text/javascript" src="/bundle.min.69fb501ac7bace7c0ca982d98573883fe084cb258084917289a51bc0bc04868a1b91b95a34c641d2854f64b4b0245430430f86fa70e19f7425062100c9b69215.js" integrity="sha512-aftQGse6znwMqYLZhXOIP&#43;CEyyWAhJFyiaUbwLwEhoobkblaNMZB0oVPZLSwJFQwQw&#43;G&#43;nDhn3QlBiEAybaSFQ=="></script>



    </body>
</html>
